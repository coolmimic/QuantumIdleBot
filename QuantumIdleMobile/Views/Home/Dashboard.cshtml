@{
    ViewData["Title"] = "ä»ªè¡¨æ¿";
}

<div class="page-container">
    <div class="header">
        <h1>âš¡ é‡å­æŒ‚æœº</h1>
        <button class="btn-icon" onclick="logout()">é€€å‡º</button>
    </div>
    
    <div class="content">
        <!-- çŠ¶æ€å¡ç‰‡ -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="margin: 0;">è´¦æˆ·ä¿¡æ¯</h3>
                <div id="runningIndicator" class="status-badge stopped">å·²åœæ­¢</div>
            </div>
            <div id="userInfo">
                <p>åŠ è½½ä¸­...</p>
            </div>
        </div>
        
        <!-- æŒ‚æœºæ§åˆ¶ -->
        <div class="card">
            <h3>æŒ‚æœºæ§åˆ¶</h3>
            
            <!-- æ¨¡å¼åˆ‡æ¢ -->
            <div class="mode-toggle" style="display: flex; gap: 8px; margin-bottom: 16px;">
                <button id="realModeBtn" class="mode-btn active" onclick="setMode(false)">
                    ğŸ’° çœŸå®æ¨¡å¼
                </button>
                <button id="simModeBtn" class="mode-btn" onclick="setMode(true)">
                    ğŸ® æ¨¡æ‹Ÿæ¨¡å¼
                </button>
            </div>
            
            <!-- å¼€å§‹/åœæ­¢æŒ‰é’® -->
            <button id="startBtn" class="btn btn-success btn-block" onclick="toggleRunning()">
                <span id="controlText">â–¶ å¼€å§‹æŒ‚æœº</span>
            </button>
            
            <!-- çŠ¶æ€æ˜¾ç¤º - å®ç›˜ -->
            <div class="stats-section">
                <div class="stats-label">ğŸ’° å®ç›˜æ•°æ®</div>
                <div class="stats-row">
                    <div class="stat-item">
                        <span class="label">ä½™é¢</span>
                        <span class="value" id="balanceValue">0.00</span>
                    </div>
                    <div class="stat-item">
                        <span class="label">ç›ˆäº</span>
                        <span class="value" id="profitValue">0.00</span>
                    </div>
                    <div class="stat-item">
                        <span class="label">æµæ°´</span>
                        <span class="value" id="turnoverValue">0.00</span>
                    </div>
                </div>
            </div>
            
            <!-- çŠ¶æ€æ˜¾ç¤º - æ¨¡æ‹Ÿ -->
            <div class="stats-section" style="margin-top: 12px;">
                <div class="stats-label">ğŸ® æ¨¡æ‹Ÿæ•°æ®</div>
                <div class="stats-row">
                    <div class="stat-item">
                        <span class="label">æ¨¡æ‹Ÿç›ˆäº</span>
                        <span class="value" id="simProfitValue">0.00</span>
                    </div>
                    <div class="stat-item">
                        <span class="label">æ¨¡æ‹Ÿæµæ°´</span>
                        <span class="value" id="simTurnoverValue">0.00</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å¿«æ·å…¥å£ -->
        <div class="quick-actions">
            <a href="/Home/Telegram" class="action-card">
                <div class="action-icon">ğŸ“±</div>
                <div class="action-text">TG è¿æ¥</div>
            </a>
            <a href="/Home/Schemes" class="action-card">
                <div class="action-icon">ğŸ“‹</div>
                <div class="action-text">æ–¹æ¡ˆç®¡ç†</div>
            </a>
            <a href="/Home/Orders" class="action-card">
                <div class="action-icon">ğŸ“</div>
                <div class="action-text">æ³¨å•åˆ—è¡¨</div>
            </a>
            <a href="/Home/Logs" class="action-card">
                <div class="action-icon">ğŸ“œ</div>
                <div class="action-text">è¿è¡Œæ—¥å¿—</div>
            </a>
            <div class="action-card" onclick="resetData()" style="cursor: pointer;">
                <div class="action-icon">ğŸ”„</div>
                <div class="action-text">æ•°æ®é‡ç½®</div>
            </div>
        </div>
        
        <!-- ä»Šæ—¥ç»Ÿè®¡ -->
        <div class="card" style="margin-top: 12px;">
            <h3>ä»Šæ—¥ç»Ÿè®¡</h3>
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-label">ä»Šæ—¥æ³¨å•</div>
                    <div class="stat-value" id="todayOrders">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ä»Šæ—¥ç›ˆäº</div>
                    <div class="stat-value" id="todayProfit">0.00</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="bottom-nav">
        <a href="/Home/Dashboard" class="nav-item active">
            <span class="nav-icon">ğŸ </span>
            <span class="nav-text">é¦–é¡µ</span>
        </a>
        <a href="/Home/Telegram" class="nav-item">
            <span class="nav-icon">ğŸ“±</span>
            <span class="nav-text">TGè¿æ¥</span>
        </a>
        <a href="/Home/Schemes" class="nav-item">
            <span class="nav-icon">ğŸ“‹</span>
            <span class="nav-text">æ–¹æ¡ˆ</span>
        </a>
        <a href="/Home/History" class="nav-item">
            <span class="nav-icon">ğŸ“Š</span>
            <span class="nav-text">å†å²</span>
        </a>
        <a href="/Home/Settings" class="nav-item">
            <span class="nav-icon">âš™ï¸</span>
            <span class="nav-text">è®¾ç½®</span>
        </a>
    </div>
</div>

<style>
    .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }
    .status-badge.running {
        background: var(--success-color);
        color: white;
    }
    .status-badge.stopped {
        background: var(--error-color);
        color: white;
    }
    
    .mode-toggle {
        background: var(--bg-tertiary);
        padding: 4px;
        border-radius: var(--radius-md);
    }
    .mode-btn {
        flex: 1;
        padding: 10px;
        border: none;
        background: transparent;
        color: var(--text-secondary);
        border-radius: var(--radius-sm);
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
    }
    .mode-btn.active {
        background: var(--accent-color);
        color: white;
        font-weight: 600;
    }
    .mode-btn:not(.active):hover {
        background: var(--bg-primary);
    }
    
    .stats-row {
        display: flex;
        justify-content: space-between;
        padding: 12px;
        background: var(--bg-tertiary);
        border-radius: var(--radius-md);
    }
    .stat-item {
        text-align: center;
    }
    .stat-item .label {
        display: block;
        font-size: 12px;
        color: var(--text-tertiary);
        margin-bottom: 4px;
    }
    .stat-item .value {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
    }
    
    .stats-section {
        margin-top: 16px;
    }
    .stats-label {
        font-size: 12px;
        color: var(--text-secondary);
        margin-bottom: 8px;
    }
</style>

@section Scripts {
<script>
    const API_BASE_URL = API_CONFIG.baseUrl;
    const token = localStorage.getItem('token');
    
    if (!token) {
        window.location.href = '/Home/Login';
    }
    
    let isRunning = false;
    let isSimulation = false;
    let isExpired = false;
    let isTelegramConnected = false;
    
    document.addEventListener('DOMContentLoaded', function() {
        loadUserInfo();
        checkTelegramStatus();
        loadBotStatus();
        loadStats();
        
        // å®šæ—¶åˆ·æ–°çŠ¶æ€
        setInterval(loadBotStatus, 5000);
    });

    async function checkTelegramStatus() {
        try {
            const response = await fetch(`${API_BASE_URL}/telegram/status`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                const result = await response.json();
                isTelegramConnected = result.isConnected;
            }
        } catch (error) {
            console.error('æ£€æŸ¥TelegramçŠ¶æ€å¤±è´¥:', error);
        }
    }

    async function loadBotStatus() {
        try {
            const response = await fetch(`${API_BASE_URL}/bot/status`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                const result = await response.json();
                if (result.success && result.data) {
                    const status = result.data;
                    isRunning = status.isRunning;
                    isSimulation = status.isSimulation;
                    
                    updateControlUI();
                    updateModeUI();
                    
                    // ä½™é¢
                    document.getElementById('balanceValue').textContent = (status.balance || 0).toFixed(2);
                    
                    // å®ç›˜ç›ˆäº
                    const profitEl = document.getElementById('profitValue');
                    const profit = status.profit || 0;
                    profitEl.textContent = (profit >= 0 ? '+' : '') + profit.toFixed(2);
                    profitEl.style.color = profit >= 0 ? 'var(--success-color)' : 'var(--error-color)';
                    
                    // å®ç›˜æµæ°´
                    document.getElementById('turnoverValue').textContent = (status.turnover || 0).toFixed(2);
                    
                    // æ¨¡æ‹Ÿç›ˆäº
                    const simProfitEl = document.getElementById('simProfitValue');
                    const simProfit = status.simProfit || 0;
                    simProfitEl.textContent = (simProfit >= 0 ? '+' : '') + simProfit.toFixed(2);
                    simProfitEl.style.color = simProfit >= 0 ? 'var(--success-color)' : 'var(--error-color)';
                    
                    // æ¨¡æ‹Ÿæµæ°´
                    document.getElementById('simTurnoverValue').textContent = (status.simTurnover || 0).toFixed(2);
                }
            }
        } catch (error) {
            console.error('åŠ è½½çŠ¶æ€å¤±è´¥:', error);
        }
    }

    async function toggleRunning() {
        // æ£€æŸ¥è´¦æˆ·æ˜¯å¦è¿‡æœŸ
        if (isExpired) {
            alert('âš ï¸ æ‚¨çš„è´¦æˆ·å·²è¿‡æœŸï¼è¯·å‰å¾€è®¾ç½®é¡µé¢æ¿€æ´»å¡å¯†ç»­è´¹åä½¿ç”¨ã€‚');
            return;
        }
        
        // æ£€æŸ¥ Telegram æ˜¯å¦å·²è¿æ¥
        if (!isTelegramConnected) {
            if (confirm('âš ï¸ è¯·å…ˆç™»å½• Telegramï¼\n\nç‚¹å‡»ç¡®å®šå‰å¾€ TG è¿æ¥é¡µé¢')) {
                window.location.href = '/Home/Telegram';
            }
            return;
        }
        
        const endpoint = isRunning ? 'stop' : 'start';
        try {
            const response = await fetch(`${API_BASE_URL}/bot/${endpoint}`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                const result = await response.json();
                if (result.success && result.data) {
                    isRunning = result.data.isRunning;
                    updateControlUI();
                }
            }
        } catch (error) {
            alert('æ“ä½œå¤±è´¥: ' + error.message);
        }
    }

    async function setMode(simulation) {
        // æ£€æŸ¥è´¦æˆ·æ˜¯å¦è¿‡æœŸ
        if (isExpired) {
            alert('âš ï¸ æ‚¨çš„è´¦æˆ·å·²è¿‡æœŸï¼è¯·å‰å¾€è®¾ç½®é¡µé¢æ¿€æ´»å¡å¯†ç»­è´¹åä½¿ç”¨ã€‚');
            return;
        }
        
        try {
            const response = await fetch(`${API_BASE_URL}/bot/mode`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ isSimulation: simulation })
            });
            
            if (response.ok) {
                const result = await response.json();
                if (result.success && result.data) {
                    isSimulation = result.data.isSimulation;
                    updateModeUI();
                }
            }
        } catch (error) {
            alert('åˆ‡æ¢æ¨¡å¼å¤±è´¥: ' + error.message);
        }
    }

    function updateControlUI() {
        const startBtn = document.getElementById('startBtn');
        const controlText = document.getElementById('controlText');
        const indicator = document.getElementById('runningIndicator');
        
        if (isRunning) {
            startBtn.className = 'btn btn-danger btn-block';
            controlText.textContent = 'â¹ åœæ­¢æŒ‚æœº';
            indicator.textContent = 'è¿è¡Œä¸­';
            indicator.className = 'status-badge running';
        } else {
            startBtn.className = 'btn btn-success btn-block';
            controlText.textContent = 'â–¶ å¼€å§‹æŒ‚æœº';
            indicator.textContent = 'å·²åœæ­¢';
            indicator.className = 'status-badge stopped';
        }
    }

    function updateModeUI() {
        const realBtn = document.getElementById('realModeBtn');
        const simBtn = document.getElementById('simModeBtn');
        
        if (isSimulation) {
            simBtn.classList.add('active');
            realBtn.classList.remove('active');
        } else {
            realBtn.classList.add('active');
            simBtn.classList.remove('active');
        }
    }
    
    function loadUserInfo() {
        try {
            const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
            const expireDate = userInfo.expireTime ? new Date(userInfo.expireTime) : null;
            isExpired = expireDate && expireDate < new Date();
            
            let expiredWarning = '';
            if (isExpired) {
                expiredWarning = `
                <div style="margin-top: 12px; padding: 12px; background: rgba(255, 77, 79, 0.1); border-radius: var(--radius-sm); color: var(--error-color);">
                    âš ï¸ è´¦æˆ·å·²è¿‡æœŸï¼<a href="/Home/Settings" style="color: var(--accent-color);">ç‚¹å‡»ç»­è´¹</a>
                </div>`;
            }
            
            document.getElementById('userInfo').innerHTML = `
                <div class="info-item">
                    <span class="label">ç”¨æˆ·å</span>
                    <span class="value">${userInfo.userName || 'N/A'}</span>
                </div>
                <div class="info-item">
                    <span class="label">åˆ°æœŸæ—¶é—´</span>
                    <span class="value" style="color: ${isExpired ? 'var(--error-color)' : 'var(--success-color)'}">
                        ${expireDate ? expireDate.toLocaleString('zh-CN') : 'N/A'}
                    </span>
                </div>
                ${expiredWarning}
            `;
        } catch (error) {
            console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
        }
    }
    
    async function loadStats() {
        try {
            const response = await fetch(`${API_BASE_URL}/betorder/list?page=1&size=100`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                const result = await response.json();
                if (result.success && result.data) {
                    const today = new Date().toDateString();
                    const todayOrders = result.data.filter(order => 
                        new Date(order.betTime).toDateString() === today
                    );
                    
                    document.getElementById('todayOrders').textContent = todayOrders.length;
                    
                    const todayProfit = todayOrders.reduce((sum, order) => sum + (order.profit || 0), 0);
                    const profitElement = document.getElementById('todayProfit');
                    profitElement.textContent = todayProfit.toFixed(2);
                    profitElement.style.color = todayProfit >= 0 ? 'var(--success-color)' : 'var(--error-color)';
                }
            }
        } catch (error) {
            console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
        }
    }
    
    async function resetData() {
        if (!confirm('âš ï¸ ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ•°æ®å—ï¼Ÿ\n\nè¿™å°†æ¸…é™¤ï¼š\nâ€¢ æ‰€æœ‰æŠ•æ³¨è®°å½•\nâ€¢ ç”¨æˆ·ç›ˆäºæ•°æ®\nâ€¢ æ–¹æ¡ˆç›ˆäºæ•°æ®\n\næ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼')) {
            return;
        }
        
        try {
            const response = await fetch(`${API_BASE_URL}/user/reset-data`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const result = await response.json();
            
            if (result.success) {
                alert(`âœ… ${result.message}`);
                // åˆ·æ–°é¡µé¢æ•°æ®
                loadBotStatus();
                loadStats();
            } else {
                alert(`âŒ ${result.message}`);
            }
        } catch (error) {
            console.error('é‡ç½®æ•°æ®å¤±è´¥:', error);
            alert('é‡ç½®æ•°æ®å¤±è´¥ï¼š' + error.message);
        }
    }
    
    function logout() {
        localStorage.removeItem('token');
        localStorage.removeItem('userName');
        localStorage.removeItem('userInfo');
        window.location.href = '/Home/Login';
    }
</script>
}
