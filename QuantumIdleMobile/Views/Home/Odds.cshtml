@{
    ViewData["Title"] = "æ³¨å•è®°å½•";
}

<div class="page-container">
    <div class="header">
        <h1>ğŸ“‘ æ³¨å•è®°å½•</h1>
        <button class="btn-icon" onclick="refreshOrders()">ğŸ”„</button>
    </div>
    
    <div class="content">
        <div id="ordersList" class="orders-list">
            <div class="loading-state">
                <div class="spinner"></div>
                <p>åŠ è½½ä¸­...</p>
            </div>
        </div>
    </div>
    
    <div class="bottom-nav">
        <a href="/Home/Dashboard" class="nav-item">
            <span class="nav-icon">ğŸ </span>
            <span class="nav-text">é¦–é¡µ</span>
        </a>
        <a href="/Home/Telegram" class="nav-item">
            <span class="nav-icon">ğŸ“±</span>
            <span class="nav-text">TGè¿æ¥</span>
        </a>
        <a href="/Home/Schemes" class="nav-item">
            <span class="nav-icon">ğŸ“‹</span>
            <span class="nav-text">æ–¹æ¡ˆ</span>
        </a>
        <a href="/Home/History" class="nav-item">
            <span class="nav-icon">ğŸ“Š</span>
            <span class="nav-text">å†å²</span>
        </a>
        <a href="/Home/Odds" class="nav-item active">
            <span class="nav-icon">ğŸ“‘</span>
            <span class="nav-text">æ³¨å•</span>
        </a>
        <a href="/Home/Settings" class="nav-item">
            <span class="nav-icon">âš™ï¸</span>
            <span class="nav-text">è®¾ç½®</span>
        </a>
    </div>
</div>

<style>
    .orders-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding-bottom: 20px;
    }

    .order-card {
        background: white;
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        border: 1px solid #f0f0f0;
        transition: transform 0.2s;
    }

    .order-card:active {
        transform: scale(0.98);
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        font-size: 13px;
        color: #666;
    }

    .issue-number {
        font-weight: 500;
        color: #333;
    }

    .card-body {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }

    .bet-info {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .bet-content {
        font-size: 18px;
        font-weight: bold;
        color: #333;
    }

    .bet-amount {
        font-size: 14px;
        color: #666;
    }

    .card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 10px;
        border-top: 1px solid #f5f5f5;
        font-size: 12px;
        color: #999;
    }

    /* Status Badges */
    .status-badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
    }

    .status-0 { background: #e6f7ff; color: #1890ff; } /* å¾…å¼€å¥– */
    .status-1 { background: #f6ffed; color: #52c41a; } /* å·²ç»“ç®— */
    .status-2 { background: #fff1f0; color: #f5222d; } /* å¤±è´¥ */
    .status-3 { background: #f5f5f5; color: #d9d9d9; } /* å–æ¶ˆ */
    .status-4 { background: #fffbe6; color: #faad14; } /* å¾…ç¡®è®¤ */

    .profit-positive { color: #52c41a; font-weight: bold; }
    .profit-negative { color: #f5222d; font-weight: bold; }
    .profit-zero { color: #999; }
</style>

@section Scripts {
<script>
    // åŠ¨æ€æ„å»º API åœ°å€ï¼Œé€‚é…å†…ç½‘å’Œå¤–ç½‘è®¿é—®
    const API_BASE_URL = API_CONFIG.baseUrl;
    const token = localStorage.getItem('token');
    
    if (!token) {
        window.location.href = '/Home/Login';
    }

    // çŠ¶æ€æ˜ å°„
    const StatusMap = {
        0: 'å¾…å¼€å¥–',
        1: 'å·²ç»“ç®—',
        2: 'ä¸‹æ³¨å¤±è´¥',
        3: 'å·²å–æ¶ˆ',
        4: 'å·²å‘é€'
    };

    function formatTime(timeStr) {
        const date = new Date(timeStr);
        return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
    }

    function renderOrder(order) {
        let statusClass = `status-${order.status}`;
        let statusText = StatusMap[order.status] || 'æœªçŸ¥';
        let profitHtml = '';

        // å¦‚æœå·²ç»“ç®—ï¼Œæ˜¾ç¤ºç›ˆäº
        if (order.status === 1) { // Settled
            const profit = order.profit;
            if (profit > 0) {
                profitHtml = `<span class="profit-positive">+${profit}</span>`;
                statusClass = 'status-1';
            } else if (profit < 0) {
                profitHtml = `<span class="profit-negative">${profit}</span>`;
                // è¾“äº†ä¹Ÿç®—å·²ç»“ç®—ï¼Œä½†ä¹Ÿå¯ä»¥ç”¨ä¸åŒçš„æ ·å¼
                statusClass = 'status-1';
            } else {
                profitHtml = `<span class="profit-zero">0</span>`;
            }
        }

        return `
            <div class="order-card">
                <div class="card-header">
                    <span class="issue-number">ç¬¬ ${order.issueNumber} æœŸ</span>
                    <span class="status-badge ${statusClass}">${statusText}</span>
                </div>
                <div class="card-body">
                    <div class="bet-info">
                        <span class="bet-content">${order.betContent}</span>
                        <span class="bet-amount">æŠ•å…¥: ${order.amount}</span>
                    </div>
                    <div class="result-info">
                        ${profitHtml}
                    </div>
                </div>
                <div class="card-footer">
                    <span>${order.schemeId ? 'æ–¹æ¡ˆæŠ•æ³¨' : 'æ‰‹åŠ¨æŠ•æ³¨'}</span>
                    <span>${formatTime(order.betTime)}</span>
                </div>
            </div>
        `;
    }

    async function loadOrders() {
        const listEl = document.getElementById('ordersList');
        // listEl.innerHTML = '<div class="loading-state">...</div>'; // Don't wipe if refreshing nicely

        try {
            const response = await fetch(`${API_BASE_URL}/BetOrder/list?page=1&size=50`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                if (result.data.length === 0) {
                    listEl.innerHTML = '<div class="empty-state">æš‚æ— æ³¨å•è®°å½•</div>';
                    return;
                }

                listEl.innerHTML = result.data.map(renderOrder).join('');
            } else {
                listEl.innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥</div>';
            }
        } catch (error) {
            console.error('åŠ è½½æ³¨å•å¤±è´¥:', error);
            listEl.innerHTML = '<div class="empty-state">ç½‘ç»œé”™è¯¯</div>';
        }
    }

    function refreshOrders() {
        loadOrders();
    }

    // åˆå§‹åŠ è½½
    loadOrders();
    
    // è‡ªåŠ¨åˆ·æ–° (æ¯10ç§’)
    setInterval(loadOrders, 10000);
</script>
}
