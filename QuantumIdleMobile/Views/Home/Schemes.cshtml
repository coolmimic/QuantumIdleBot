@{
    ViewData["Title"] = "æ–¹æ¡ˆç®¡ç†";
}

<div class="page-container">
    <div class="header">
        <h1>ğŸ“‹ æ–¹æ¡ˆç®¡ç†</h1>
        <div class="header-actions">
            <button class="btn-icon" onclick="refreshSchemes()">åˆ·æ–°</button>
            <a href="/Home/SchemeEdit" class="btn btn-primary">+ æ–°å»º</a>
        </div>
    </div>
    
    <div class="content">
        <div class="schemes-list" id="schemesList">
            <div class="loading-state">
                <div class="spinner"></div>
                <p>åŠ è½½ä¸­...</p>
            </div>
        </div>
    </div>
    
    <div class="bottom-nav">
        <a href="/Home/Dashboard" class="nav-item">
            <span class="nav-icon">ğŸ </span>
            <span class="nav-text">é¦–é¡µ</span>
        </a>
        <a href="/Home/Telegram" class="nav-item">
            <span class="nav-icon">ğŸ“±</span>
            <span class="nav-text">TGè¿æ¥</span>
        </a>
        <a href="/Home/Schemes" class="nav-item active">
            <span class="nav-icon">ğŸ“‹</span>
            <span class="nav-text">æ–¹æ¡ˆ</span>
        </a>
        <a href="/Home/Orders" class="nav-item">
            <span class="nav-icon">ğŸ“</span>
            <span class="nav-text">æ³¨å•</span>
        </a>
        <a href="/Home/Settings" class="nav-item">
            <span class="nav-icon">âš™ï¸</span>
            <span class="nav-text">è®¾ç½®</span>
        </a>
    </div>
</div>

<style>
    .schemes-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .loading-state, .empty-state, .error-state {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-secondary);
    }
    .loading-state .spinner {
        width: 32px;
        height: 32px;
        border: 3px solid rgba(255, 255, 255, 0.2);
        border-top-color: var(--accent-color);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin: 0 auto 12px;
    }
    @@keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .scheme-item {
        background: var(--bg-secondary);
        border-radius: var(--radius-md);
        padding: 12px;
        border-left: 3px solid var(--text-tertiary);
        cursor: pointer;
        transition: all 0.2s;
    }
    .scheme-item:hover {
        background: var(--bg-tertiary);
    }
    .scheme-item.enabled {
        border-left-color: var(--success-color);
    }
    .scheme-item.disabled {
        border-left-color: var(--error-color);
        opacity: 0.7;
    }
    
    .scheme-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    .scheme-name {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-primary);
    }
    .scheme-actions {
        display: flex;
        gap: 6px;
    }
    .btn-icon-small {
        width: 28px;
        height: 28px;
        border: none;
        background: var(--bg-tertiary);
        border-radius: var(--radius-sm);
        cursor: pointer;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .btn-icon-small:hover {
        background: var(--bg-primary);
    }
    
    .scheme-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
    }
    .scheme-field {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    .scheme-field .label {
        font-size: 11px;
        color: var(--text-tertiary);
    }
    .scheme-field .value {
        font-size: 13px;
        color: var(--text-primary);
        font-weight: 500;
    }
    .scheme-field .value.profit-positive {
        color: var(--success-color);
    }
    .scheme-field .value.profit-negative {
        color: var(--error-color);
    }
</style>

@section Scripts {
<script>
    const API_BASE_URL = API_CONFIG.baseUrl;
    const token = localStorage.getItem('token');
    
    if (!token) {
        window.location.href = '/Home/Login';
    }

    // æ¸¸æˆç±»å‹æ˜ å°„
    const gameTypeMap = {
        0: 'æ‰«é›·', 1: 'å¿«ä¸‰', 2: '28', 3: '20', 4: 'æ—¶å½©'
    };

    // å‡ºå·è§„åˆ™æ˜ å°„
    const drawRuleMap = {
        0: 'å›ºå®š', 1: 'å¼€æŸæŠ•æŸ', 2: 'é¾™è™',
        3: 'èµ°åŠ¿', 4: '01å½¢æ€', 5: 'åˆ†æ”¯', 6: 'è·Ÿéš'
    };
    
    // å€ç‡ç±»å‹æ˜ å°„
    const oddsTypeMap = {
        0: 'ç›´çº¿'
    };

    document.addEventListener('DOMContentLoaded', loadSchemes);

    // æˆªå–ç¾¤ç»„åï¼ˆæœ€å¤š6ä¸ªå­—ç¬¦ï¼‰
    function formatGroupName(name) {
        if (!name) return '-';
        return name.length > 6 ? name.substring(0, 6) + '..' : name;
    }
    
    // æ ¼å¼åŒ–ç›ˆäº
    function formatProfit(value) {
        const v = value || 0;
        const cls = v >= 0 ? 'profit-positive' : 'profit-negative';
        const prefix = v >= 0 ? '+' : '';
        return `<span class="value ${cls}">${prefix}${v.toFixed(2)}</span>`;
    }

    async function loadSchemes() {
        const container = document.getElementById('schemesList');
        container.innerHTML = `
            <div class="loading-state">
                <div class="spinner"></div>
                <p>åŠ è½½ä¸­...</p>
            </div>
        `;
        
        try {
            const response = await fetch(`${API_BASE_URL}/scheme`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            const result = await response.json();
            
            if (result.success && result.data) {
                displaySchemes(result.data);
            } else {
                container.innerHTML = '<div class="error-state">åŠ è½½å¤±è´¥</div>';
            }
        } catch (error) {
            console.error('åŠ è½½æ–¹æ¡ˆå¤±è´¥:', error);
            container.innerHTML = '<div class="error-state">ç½‘ç»œé”™è¯¯</div>';
        }
    }

    function displaySchemes(schemes) {
        const container = document.getElementById('schemesList');
        
        if (schemes.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <p style="margin-bottom: 16px;">ğŸ“­ æš‚æ— æ–¹æ¡ˆ</p>
                    <a href="/Home/SchemeEdit" class="btn btn-primary">åˆ›å»ºç¬¬ä¸€ä¸ªæ–¹æ¡ˆ</a>
                </div>
            `;
            return;
        }

        let html = '';
        schemes.forEach(s => {
            const gameTypeName = gameTypeMap[s.gameType] || '?';
            const drawRuleName = drawRuleMap[s.drawRule] || '?';
            const oddsTypeName = oddsTypeMap[s.oddsType] || '?';
            const groupName = formatGroupName(s.tgGroupName);
            
            html += `
                <div class="scheme-item ${s.isEnabled ? 'enabled' : 'disabled'}" onclick="editScheme(${s.id})">
                    <div class="scheme-header">
                        <div class="scheme-name">${s.name}</div>
                        <div class="scheme-actions" onclick="event.stopPropagation();">
                            <button class="btn-icon-small" onclick="toggleScheme(${s.id})" title="${s.isEnabled ? 'ç¦ç”¨' : 'å¯ç”¨'}">
                                ${s.isEnabled ? 'â¸' : 'â–¶'}
                            </button>
                            <button class="btn-icon-small" onclick="deleteScheme(${s.id})" title="åˆ é™¤">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                    <div class="scheme-grid">
                        <div class="scheme-field">
                            <span class="label">ç¾¤ç»„</span>
                            <span class="value">${groupName}</span>
                        </div>
                        <div class="scheme-field">
                            <span class="label">æ¸¸æˆ</span>
                            <span class="value">${gameTypeName}</span>
                        </div>
                        <div class="scheme-field">
                            <span class="label">è§„åˆ™</span>
                            <span class="value">${drawRuleName}/${oddsTypeName}</span>
                        </div>
                        <div class="scheme-field">
                            <span class="label">å®ç›˜ç›ˆäº</span>
                            ${formatProfit(s.profit)}
                        </div>
                        <div class="scheme-field">
                            <span class="label">æ¨¡æ‹Ÿç›ˆäº</span>
                            ${formatProfit(s.simProfit)}
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }

    function editScheme(id) {
        window.location.href = `/Home/SchemeEdit?id=${id}`;
    }

    async function toggleScheme(id) {
        try {
            const response = await fetch(`${API_BASE_URL}/scheme/${id}/toggle`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                loadSchemes();
            }
        } catch (error) {
            console.error('åˆ‡æ¢çŠ¶æ€å¤±è´¥:', error);
        }
    }

    async function deleteScheme(id) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–¹æ¡ˆå—ï¼Ÿ')) return;
        
        try {
            const response = await fetch(`${API_BASE_URL}/scheme/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                loadSchemes();
            }
        } catch (error) {
            console.error('åˆ é™¤æ–¹æ¡ˆå¤±è´¥:', error);
        }
    }

    function refreshSchemes() {
        loadSchemes();
    }
</script>
}
