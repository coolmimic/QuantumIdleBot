@{
    ViewData["Title"] = "Telegram è¿æ¥";
}

<div class="page-container">
    <div class="header">
        <h1>ğŸ“± Telegram è¿æ¥</h1>
    </div>
    
    <div class="content">
        <div class="card">
            <h3>è¿æ¥çŠ¶æ€</h3>
            <div id="connectionStatus" class="status-info">
                <p>æ£€æŸ¥ä¸­...</p>
            </div>
        </div>

        <div class="card" id="loginSection" style="display: none;">
            <h3>ç™»å½• Telegram</h3>
            
            <!-- å·²å­˜åœ¨çš„ session å¿«é€Ÿé€‰æ‹© -->
            <div id="existingSessionsDiv" style="display: none; margin-bottom: 16px;">
                <label style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; display: block;">å¿«é€Ÿç™»å½•ï¼ˆå·²ä¿å­˜çš„è´¦å·ï¼‰</label>
                <select id="existingSessions" class="form-input" onchange="selectExistingSession()">
                    <option value="">é€‰æ‹©å·²ä¿å­˜çš„æ‰‹æœºå·...</option>
                </select>
            </div>
            
            <form id="tgLoginForm">
                <div class="form-group">
                    <label for="phoneNumber">æ‰‹æœºå·</label>
                    <input type="tel" id="phoneNumber" class="form-input" 
                           placeholder="+86 13800138000" required />
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary btn-block" id="initBtn">
                        åˆå§‹åŒ–è¿æ¥
                    </button>
                </div>
            </form>
        </div>

        <div class="card" id="authSection" style="display: none;">
            <h3 id="authTitle">è¾“å…¥éªŒè¯ç </h3>
            <form id="authForm">
                <div class="form-group">
                    <label id="authLabel" for="authCode">éªŒè¯ç </label>
                    <input type="text" id="authCode" class="form-input" 
                           placeholder="è¯·è¾“å…¥éªŒè¯ç " required autocomplete="one-time-code" />
                </div>
                <div class="form-group" style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;" id="authBtn">æäº¤</button>
                    <button type="button" class="btn btn-secondary" onclick="cancelAuth()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>

        <div class="card" id="chatsSection" style="display: none;">
            <h3>ç¾¤ç»„åˆ—è¡¨</h3>
            <div id="chatsList" class="chats-list">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <div class="card" id="actionsSection" style="display: none;">
            <h3>æ“ä½œ</h3>
            <button class="btn btn-danger btn-block" onclick="disconnect()">
                æ–­å¼€è¿æ¥
            </button>
        </div>

        <div id="errorMessage" class="error-message" style="display: none;"></div>
    </div>
    
    <div class="bottom-nav">
        <a href="/Home/Dashboard" class="nav-item">
            <span class="nav-icon">ğŸ </span>
            <span class="nav-text">é¦–é¡µ</span>
        </a>
        <a href="/Home/Telegram" class="nav-item active">
            <span class="nav-icon">ğŸ“±</span>
            <span class="nav-text">TGè¿æ¥</span>
        </a>
        <a href="/Home/Schemes" class="nav-item">
            <span class="nav-icon">ğŸ“‹</span>
            <span class="nav-text">æ–¹æ¡ˆ</span>
        </a>
        <a href="/Home/History" class="nav-item">
            <span class="nav-icon">ğŸ“Š</span>
            <span class="nav-text">å†å²</span>
        </a>
        <a href="/Home/Settings" class="nav-item">
            <span class="nav-icon">âš™ï¸</span>
            <span class="nav-text">è®¾ç½®</span>
        </a>
    </div>
</div>

@section Scripts {
<script>
    const API_BASE_URL = API_CONFIG.baseUrl;
    const token = localStorage.getItem('token');
    
    if (!token) {
        window.location.href = '/Home/Login';
    }

    let currentAuthType = null;

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥çŠ¶æ€å’Œè·å–å·²å­˜åœ¨çš„ session
    document.addEventListener('DOMContentLoaded', async function() {
        await checkStatus();
        await loadExistingSessions();
    });

    async function loadExistingSessions() {
        try {
            const response = await fetch(`${API_BASE_URL}/telegram/sessions`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            const result = await response.json();
            
            if (result.success && result.data && result.data.length > 0) {
                const select = document.getElementById('existingSessions');
                select.innerHTML = '<option value="">é€‰æ‹©å·²ä¿å­˜çš„æ‰‹æœºå·...</option>';
                
                result.data.forEach(phone => {
                    const option = document.createElement('option');
                    option.value = phone;
                    option.textContent = phone;
                    select.appendChild(option);
                });
                
                document.getElementById('existingSessionsDiv').style.display = 'block';
                
                // è‡ªåŠ¨é¢„å¡«å……ç¬¬ä¸€ä¸ªæ‰‹æœºå·
                if (result.data.length === 1) {
                    document.getElementById('phoneNumber').value = result.data[0];
                }
            }
        } catch (error) {
            console.error('åŠ è½½å·²å­˜åœ¨çš„ session å¤±è´¥:', error);
        }
    }

    function selectExistingSession() {
        const select = document.getElementById('existingSessions');
        if (select.value) {
            document.getElementById('phoneNumber').value = select.value;
        }
    }

    async function checkStatus() {
        try {
            const response = await fetch(`${API_BASE_URL}/telegram/status`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                if (result.isConnected) {
                    document.getElementById('connectionStatus').innerHTML = 
                        '<p style="color: var(--success-color);">âœ… å·²è¿æ¥</p>';
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('chatsSection').style.display = 'block';
                    document.getElementById('actionsSection').style.display = 'block';
                    loadChats();
                } else {
                    document.getElementById('connectionStatus').innerHTML = 
                        '<p style="color: var(--warning-color);">âš ï¸ æœªè¿æ¥</p>';
                    document.getElementById('loginSection').style.display = 'block';
                    document.getElementById('chatsSection').style.display = 'none';
                    document.getElementById('actionsSection').style.display = 'none';
                }
            }
        } catch (error) {
            document.getElementById('connectionStatus').innerHTML = 
                '<p style="color: var(--error-color);">âŒ æ£€æŸ¥çŠ¶æ€å¤±è´¥</p>';
        }
    }

    async function loadChats() {
        try {
            const response = await fetch(`${API_BASE_URL}/telegram/chats`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            const result = await response.json();
            
            if (result.success && result.data) {
                let html = '';
                result.data.forEach(chat => {
                    html += `
                        <div class="chat-item">
                            <div class="chat-name">${chat.name}</div>
                            <div class="chat-type">${chat.isChannel ? 'é¢‘é“' : 'ç¾¤ç»„'}</div>
                        </div>
                    `;
                });
                document.getElementById('chatsList').innerHTML = html || '<div class="empty-state">æš‚æ— ç¾¤ç»„</div>';
            }
        } catch (error) {
            document.getElementById('chatsList').innerHTML = '<div class="error-state">åŠ è½½å¤±è´¥</div>';
        }
    }

    document.getElementById('tgLoginForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const phoneNumber = document.getElementById('phoneNumber').value;
        const errorDiv = document.getElementById('errorMessage');
        const submitBtn = document.getElementById('initBtn');
        const originalBtnText = submitBtn.textContent;
        
        // éªŒè¯æ‰‹æœºå·æ ¼å¼
        const phoneRegex = /^\+?[0-9]{10,15}$/;
        if (!phoneRegex.test(phoneNumber.replace(/[\s\-\(\)]/g, ''))) {
            errorDiv.textContent = 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ‰‹æœºå·æ ¼å¼ï¼ˆå¦‚ï¼š+86 13800138000ï¼‰';
            errorDiv.style.display = 'block';
            return;
        }
        
        errorDiv.style.display = 'none';
        submitBtn.disabled = true;
        submitBtn.textContent = 'è¿æ¥ä¸­...';
        
        try {
            const response = await fetch(`${API_BASE_URL}/telegram/initialize`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ phoneNumber: phoneNumber })
            });
            
            const result = await response.json();
            
            if (result.success) {
                checkStatus();
            } else if (result.requiresAuth) {
                currentAuthType = result.authType;
                showAuthForm(result.authType, result.message);
            } else {
                errorDiv.textContent = result.message || 'åˆå§‹åŒ–å¤±è´¥';
                errorDiv.style.display = 'block';
            }
        } catch (error) {
            errorDiv.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
            errorDiv.style.display = 'block';
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = originalBtnText;
        }
    });

    document.getElementById('authForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const code = document.getElementById('authCode').value;
        const errorDiv = document.getElementById('errorMessage');
        const submitBtn = document.getElementById('authBtn');
        const originalBtnText = submitBtn.textContent;
        
        errorDiv.style.display = 'none';
        submitBtn.disabled = true;
        submitBtn.textContent = 'éªŒè¯ä¸­...';
        
        try {
            const response = await fetch(`${API_BASE_URL}/telegram/submit-auth`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ code: code })
            });
            
            const result = await response.json();
            
            if (result.success) {
                hideAuthForm();
                checkStatus();
            } else if (result.requiresAuth) {
                if (result.authType && result.authType !== currentAuthType) {
                    currentAuthType = result.authType;
                    showAuthForm(result.authType, result.message);
                } else {
                    errorDiv.textContent = result.message || 'éªŒè¯ç æˆ–å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•';
                    errorDiv.style.display = 'block';
                }
                document.getElementById('authCode').value = '';
            } else {
                errorDiv.textContent = result.message || 'è®¤è¯å¤±è´¥';
                errorDiv.style.display = 'block';
            }
        } catch (error) {
            errorDiv.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
            errorDiv.style.display = 'block';
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = originalBtnText;
        }
    });

    function showAuthForm(authType, message) {
        const authSection = document.getElementById('authSection');
        const authTitle = document.getElementById('authTitle');
        const authLabel = document.getElementById('authLabel');
        const authCodeInput = document.getElementById('authCode');
        const errorDiv = document.getElementById('errorMessage');
        
        authTitle.textContent = authType === 'password' ? 'ğŸ” è¾“å…¥å¯†ç ' : 'ğŸ”¢ è¾“å…¥éªŒè¯ç ';
        authLabel.textContent = authType === 'password' ? 'ä¸¤æ­¥éªŒè¯å¯†ç ' : 'éªŒè¯ç ';
        authCodeInput.placeholder = authType === 'password' ? 'è¯·è¾“å…¥æ‚¨çš„ä¸¤æ­¥éªŒè¯å¯†ç ' : 'è¯·è¾“å…¥ Telegram å‘é€çš„éªŒè¯ç ';
        authCodeInput.type = authType === 'password' ? 'password' : 'text';
        
        document.getElementById('loginSection').style.display = 'none';
        authSection.style.display = 'block';
        authCodeInput.focus();
        
        // æ¸…ç©ºä¹‹å‰çš„é”™è¯¯ä¿¡æ¯
        errorDiv.style.display = 'none';
    }

    function hideAuthForm() {
        document.getElementById('authSection').style.display = 'none';
        document.getElementById('authCode').value = '';
        document.getElementById('errorMessage').style.display = 'none';
        currentAuthType = null;
    }

    function cancelAuth() {
        hideAuthForm();
        document.getElementById('loginSection').style.display = 'block';
    }

    async function disconnect() {
        if (!confirm('ç¡®å®šè¦æ–­å¼€ Telegram è¿æ¥å—ï¼Ÿ')) return;
        
        try {
            const response = await fetch(`${API_BASE_URL}/telegram/disconnect`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            const result = await response.json();
            if (result.success) {
                checkStatus();
            }
        } catch (error) {
            alert('æ–­å¼€è¿æ¥å¤±è´¥');
        }
    }
</script>
}
