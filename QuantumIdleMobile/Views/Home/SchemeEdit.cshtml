@{
    ViewData["Title"] = ViewData["SchemeId"] != null ? "ç¼–è¾‘æ–¹æ¡ˆ" : "æ–°å»ºæ–¹æ¡ˆ";
    var schemeId = ViewData["SchemeId"];
}

<div class="page-container">
    <div class="header">
        <div style="display: flex; align-items: center; gap: 12px;">
            <button class="btn-icon" onclick="goBack()">â†</button>
            <h1>@(schemeId != null ? "ç¼–è¾‘æ–¹æ¡ˆ" : "æ–°å»ºæ–¹æ¡ˆ")</h1>
        </div>
        <button class="btn btn-primary" onclick="saveScheme()" id="saveBtn">ä¿å­˜</button>
    </div>
    
    <div class="content">
        <!-- åŠ è½½é®ç½©å±‚ -->
        <div id="loadingOverlay" class="loading-overlay">
            <div class="loading-content">
                <div class="spinner"></div>
                <p>æ­£åœ¨åŠ è½½æ•°æ®...</p>
            </div>
        </div>
        
        <input type="hidden" id="schemeId" value="@schemeId" />
        
        <!-- åŸºæœ¬ä¿¡æ¯ -->
        <div class="card">
            <h3>åŸºæœ¬ä¿¡æ¯</h3>
            <div class="form-group">
                <label for="schemeName">æ–¹æ¡ˆåç§° *</label>
                <input type="text" id="schemeName" class="form-input" placeholder="è¯·è¾“å…¥æ–¹æ¡ˆåç§°" required />
            </div>
            
            <div class="form-group">
                <label for="tgGroupSelect">Telegram ç¾¤ç»„ *</label>
                <div style="display: flex; gap: 8px;">
                    <select id="tgGroupSelect" class="form-input" style="flex: 1;">
                        <option value="">è¯·é€‰æ‹©ç¾¤ç»„...</option>
                    </select>
                    <button type="button" class="btn btn-secondary" onclick="refreshGroups()">åˆ·æ–°</button>
                </div>
            </div>
            
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="isEnabled" checked />
                    <span>å¯ç”¨æ–¹æ¡ˆ</span>
                </label>
            </div>
        </div>
        
        <!-- æ¸¸æˆè®¾ç½® -->
        <div class="card">
            <h3>æ¸¸æˆè®¾ç½®</h3>
            <div class="form-group">
                <label for="gameType">æ¸¸æˆç±»å‹</label>
                <select id="gameType" class="form-input">
                    <option value="0">æ‰«é›·</option>
                    <option value="1">å¿«ä¸‰</option>
                    <option value="2">åŠ æ‹¿å¤§28</option>
                    <option value="3">åŠ æ‹¿å¤§20</option>
                    <option value="4">æ—¶æ—¶å½©</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="playMode">ç©æ³•æ¨¡å¼</label>
                <select id="playMode" class="form-input" onchange="updatePositionPanel()">
                    <option value="0">å¤§å°å•åŒ</option>
                    <option value="1">æ•°å­—</option>
                    <option value="301">ç»„åˆ</option>
                    <option value="302">é«˜å€</option>
                    <option value="1100">å®šä½èƒ†</option>
                    <option value="1102">å®šä½å¤§å°å•åŒ</option>
                    <option value="1202">é¾™è™</option>
                    <option value="1203">å’Œ</option>
                </select>
            </div>
            
            <div class="form-group" id="positionGroup" style="display: none;">
                <label>ä½ç½®é€‰æ‹©</label>
                <div class="position-checkboxes">
                    <label><input type="checkbox" name="position" value="0"><span>ä¸‡</span></label>
                    <label><input type="checkbox" name="position" value="1"><span>åƒ</span></label>
                    <label><input type="checkbox" name="position" value="2"><span>ç™¾</span></label>
                    <label><input type="checkbox" name="position" value="3"><span>å</span></label>
                    <label><input type="checkbox" name="position" value="4"><span>ä¸ª</span></label>
                </div>
            </div>
        </div>
        
        <!-- å€ç‡é…ç½®ï¼ˆå¯æŠ˜å ï¼‰ -->
        <div class="card collapsible-card">
            <div class="card-header" onclick="togglePanel('oddsPanel')">
                <div>
                    <h3 style="margin: 0;">ğŸ“ˆ å€ç‡é…ç½®</h3>
                    <p id="oddsPreview" class="card-preview">ä½¿ç”¨é»˜è®¤åºåˆ—</p>
                </div>
                <span class="collapse-icon" id="oddsIcon">â–¼</span>
            </div>
            <div id="oddsPanel" class="collapsible-content" style="display: none;">
                <div class="form-group">
                    <label for="oddsType">å€ç‡ç±»å‹</label>
                    <select id="oddsType" class="form-input">
                        <option value="0">ç›´çº¿å€ç‡</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="progressMode">é€’è¿›æ¨¡å¼</label>
                    <select id="progressMode" class="form-input">
                        <option value="0">æŒ‚äº†åŠ å€ï¼ˆè¾“åé€’å¢ï¼‰</option>
                        <option value="1">ä¸­äº†åŠ å€ï¼ˆèµ¢åé€’å¢ï¼‰</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>å€æŠ•åºåˆ—</label>
                    <div id="sequenceList" style="display: flex; flex-direction: column; gap: 8px;"></div>
                    <button type="button" class="btn btn-secondary" style="margin-top: 8px;" onclick="addSequenceItem()">+ æ·»åŠ ä¸€å…³</button>
                </div>
                
                <div style="padding: 12px; background: var(--bg-tertiary); border-radius: var(--radius-md); margin-top: 12px;">
                    <h4 style="margin: 0 0 8px 0; font-size: 13px;">å¿«é€Ÿç”Ÿæˆ</h4>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <input type="number" id="quickStart" class="form-input" value="10" min="1" style="width: 80px;" placeholder="èµ·å§‹" />
                        <select id="quickMultiplier" class="form-input" style="width: 80px;">
                            <option value="1.5">Ã—1.5</option>
                            <option value="2" selected>Ã—2</option>
                            <option value="3">Ã—3</option>
                        </select>
                        <input type="number" id="quickCount" class="form-input" value="10" min="1" max="50" style="width: 80px;" placeholder="å…³æ•°" />
                        <button class="btn btn-secondary" onclick="generateSequence()">ç”Ÿæˆ</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å‡ºå·è§„åˆ™ï¼ˆå¯æŠ˜å ï¼‰ -->
        <div class="card collapsible-card">
            <div class="card-header" onclick="togglePanel('drawRulePanel')">
                <div>
                    <h3 style="margin: 0;">ğŸ¯ å‡ºå·è§„åˆ™</h3>
                    <p id="drawRulePreview" class="card-preview">æœªé…ç½®</p>
                </div>
                <span class="collapse-icon" id="drawRuleIcon">â–¼</span>
            </div>
            <div id="drawRulePanel" class="collapsible-content" style="display: none;">
                <div class="form-group">
                    <label for="drawRule">è§„åˆ™ç±»å‹</label>
                    <select id="drawRule" class="form-input" onchange="updateDrawRuleForm()">
                        <option value="0">å›ºå®šå·ç </option>
                        <option value="1">å¼€æŸæŠ•æŸ</option>
                        <option value="2">æ–©é¾™è·Ÿé¾™</option>
                        <option value="3">å·ç èµ°åŠ¿</option>
                        <option value="4">01å½¢æ€</option>
                        <option value="5">åˆ†æ”¯èµ°åŠ¿</option>
                        <option value="6">ç»“æœè·Ÿéš</option>
                    </select>
                </div>
                
                <!-- è§„åˆ™è¡¨å•å®¹å™¨ -->
                <div id="drawRuleFormContainer"></div>
            </div>
        </div>
        
        <!-- æ­¢ç›ˆæ­¢æŸ -->
        <div class="card">
            <h3>æ­¢ç›ˆæ­¢æŸ</h3>
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="enableStopProfitLoss" onchange="toggleStopProfitLoss()" />
                    <span>å¯ç”¨æ­¢ç›ˆæ­¢æŸ</span>
                </label>
            </div>
            
            <div id="stopProfitLossGroup" style="display: none;">
                <div class="form-group">
                    <label for="stopProfitAmount">æ­¢ç›ˆé‡‘é¢</label>
                    <input type="number" id="stopProfitAmount" class="form-input" step="0.01" placeholder="0.00" />
                </div>
                
                <div class="form-group">
                    <label for="stopLossAmount">æ­¢æŸé‡‘é¢</label>
                    <input type="number" id="stopLossAmount" class="form-input" step="0.01" placeholder="0.00" />
                </div>
            </div>
        </div>
        
        <!-- åˆ é™¤æŒ‰é’®ï¼ˆä»…ç¼–è¾‘æ—¶æ˜¾ç¤ºï¼‰ -->
        <div class="card" id="deleteSection" style="display: none;">
            <button class="btn btn-danger btn-block" onclick="deleteScheme()">åˆ é™¤æ–¹æ¡ˆ</button>
        </div>
    </div>
    
    <div class="bottom-nav">
        <a href="/Home/Dashboard" class="nav-item">
            <span class="nav-icon">ğŸ </span>
            <span class="nav-text">é¦–é¡µ</span>
        </a>
        <a href="/Home/Telegram" class="nav-item">
            <span class="nav-icon">ğŸ“±</span>
            <span class="nav-text">TGè¿æ¥</span>
        </a>
        <a href="/Home/Schemes" class="nav-item active">
            <span class="nav-icon">ğŸ“‹</span>
            <span class="nav-text">æ–¹æ¡ˆ</span>
        </a>
        <a href="/Home/History" class="nav-item">
            <span class="nav-icon">ğŸ“Š</span>
            <span class="nav-text">å†å²</span>
        </a>
        <a href="/Home/Settings" class="nav-item">
            <span class="nav-icon">âš™ï¸</span>
            <span class="nav-text">è®¾ç½®</span>
        </a>
    </div>
</div>

<style>
    /* åŠ è½½é®ç½©å±‚ */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }
    .loading-overlay.hidden {
        display: none;
    }
    .loading-content {
        text-align: center;
        color: white;
    }
    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top-color: var(--accent-color);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin: 0 auto 16px;
    }
    @@keyframes spin {
        to { transform: rotate(360deg); }
    }
    .loading-content p {
        margin: 0;
        font-size: 14px;
    }

    .collapsible-card .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        padding: 4px 0;
    }
    .collapsible-card .card-preview {
        color: var(--text-tertiary);
        font-size: 12px;
        margin: 4px 0 0 0;
    }
    .collapsible-card .collapse-icon {
        color: var(--text-tertiary);
        font-size: 12px;
        transition: transform 0.2s;
    }
    .collapsible-card .collapse-icon.expanded {
        transform: rotate(180deg);
    }
    .collapsible-content {
        padding-top: 16px;
        border-top: 1px solid var(--border-color);
        margin-top: 12px;
    }
    .rule-form-section {
        padding: 12px;
        background: var(--bg-tertiary);
        border-radius: var(--radius-md);
        margin-top: 12px;
    }
    .rule-form-section h4 {
        margin: 0 0 12px 0;
        font-size: 13px;
        color: var(--text-secondary);
    }
    .tag-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }
    .tag-item {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        background: var(--accent-color);
        color: white;
        border-radius: var(--radius-sm);
        font-size: 13px;
    }
    .tag-item .remove {
        cursor: pointer;
        opacity: 0.7;
    }
    .tag-item .remove:hover {
        opacity: 1;
    }
</style>

@section Scripts {
<script>
    const port = 5000;
    const protocol = window.location.protocol;
    const hostname = window.location.hostname;
    const API_BASE_URL = `${protocol}//${hostname}:${port}/api`;
    const token = localStorage.getItem('token');
    const schemeId = document.getElementById('schemeId').value;
    const isEdit = schemeId && schemeId !== '';
    
    if (!token) {
        window.location.href = '/Home/Login';
    }
    
    // æ•°æ®å­˜å‚¨
    let groupsList = [];
    let oddsSequence = [10, 20, 40, 80, 160];
    let drawRuleData = {};
    
    // è§„åˆ™è¡¨å•æ¨¡æ¿
    const ruleFormTemplates = {
        0: `<!-- å›ºå®šå·ç  -->
            <div class="rule-form-section">
                <h4>ç›®æ ‡å·ç </h4>
                <div id="targetNumbersList" class="tag-list" style="margin-bottom: 8px;"></div>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="newTargetNumber" class="form-input" placeholder="è¾“å…¥å·ç ï¼ˆå¤§ã€å•ã€1ç­‰ï¼‰" style="flex: 1;" />
                    <button class="btn btn-secondary" onclick="addTargetNumber()">æ·»åŠ </button>
                </div>
            </div>`,
        1: `<!-- å¼€æŸæŠ•æŸ -->
            <div class="rule-form-section">
                <h4>æ˜ å°„è§„åˆ™</h4>
                <div id="followLastRules" style="display: flex; flex-direction: column; gap: 8px;"></div>
                <button class="btn btn-secondary" style="margin-top: 8px;" onclick="addFollowLastRule()">+ æ·»åŠ è§„åˆ™</button>
            </div>`,
        2: `<!-- æ–©é¾™è·Ÿé¾™ -->
            <div class="rule-form-section">
                <div class="form-group">
                    <label>ç›‘æ§æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
                    <input type="text" id="sd_monitorTags" class="form-input" placeholder="å¤§,å•" onchange="updateDrawRuleData()" />
                </div>
                <div class="form-group">
                    <label>è¿ç»­æœŸæ•°é˜ˆå€¼</label>
                    <input type="number" id="sd_consecutiveCount" class="form-input" value="3" min="1" onchange="updateDrawRuleData()" />
                </div>
                <div class="form-group">
                    <label>è§¦å‘æ–¹å¼</label>
                    <select id="sd_triggerMode" class="form-input" onchange="updateDrawRuleData()">
                        <option value="0">æ¯æœŸæ£€æŸ¥</option>
                        <option value="1">è§¦å‘åè¿æŠ•</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æŠ•æ³¨æ¨¡å¼</label>
                    <select id="sd_betMode" class="form-input" onchange="updateDrawRuleData()">
                        <option value="0">æ­£æŠ•ï¼ˆè·Ÿé¾™ï¼‰</option>
                        <option value="1">åæŠ•ï¼ˆæ–©é¾™ï¼‰</option>
                    </select>
                </div>
            </div>`,
        3: `<!-- å·ç èµ°åŠ¿ -->
            <div class="rule-form-section">
                <div class="form-group">
                    <label>ç›‘æ§å·ç ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
                    <input type="text" id="nt_monitorNumbers" class="form-input" placeholder="å¤§,å•" onchange="updateDrawRuleData()" />
                </div>
                <div class="form-group">
                    <label>ç›‘æ§æ¨¡å¼</label>
                    <select id="nt_isOmissionMode" class="form-input" onchange="updateDrawRuleData()">
                        <option value="true">é—æ¼ç›‘æ§ï¼ˆNæœŸæ²¡å¼€ï¼‰</option>
                        <option value="false">è¿å¼€ç›‘æ§ï¼ˆè¿ç»­å¼€NæœŸï¼‰</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>é˜ˆå€¼æœŸæ•°</label>
                    <input type="number" id="nt_thresholdCount" class="form-input" value="10" min="1" onchange="updateDrawRuleData()" />
                </div>
                <div class="form-group">
                    <label>æŠ•æ³¨æ¨¡å¼</label>
                    <select id="nt_betMode" class="form-input" onchange="updateDrawRuleData()">
                        <option value="0">æ­£æŠ•</option>
                        <option value="1">åæŠ•</option>
                    </select>
                </div>
            </div>`,
        4: `<!-- 01å½¢æ€ -->
            <div class="rule-form-section">
                <div style="display: flex; gap: 12px;">
                    <div class="form-group" style="flex: 1;">
                        <label>0 ä»£è¡¨</label>
                        <input type="text" id="pt_codeZero" class="form-input" value="å¤§" onchange="updateDrawRuleData()" />
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>1 ä»£è¡¨</label>
                        <input type="text" id="pt_codeOne" class="form-input" value="å°" onchange="updateDrawRuleData()" />
                    </div>
                </div>
                <div class="form-group">
                    <label>ç­–ç•¥åˆ—è¡¨</label>
                    <div id="patternStrategyList" style="display: flex; flex-direction: column; gap: 8px;"></div>
                    <button class="btn btn-secondary" style="margin-top: 8px;" onclick="addPatternStrategy()">+ æ·»åŠ ç­–ç•¥</button>
                </div>
            </div>`,
        5: `<!-- åˆ†æ”¯èµ°åŠ¿ -->
            <div class="rule-form-section">
                <div style="display: flex; gap: 12px;">
                    <div class="form-group" style="flex: 1;">
                        <label>0 ä»£è¡¨</label>
                        <input type="text" id="bt_codeZero" class="form-input" value="å¤§" onchange="updateDrawRuleData()" />
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>1 ä»£è¡¨</label>
                        <input type="text" id="bt_codeOne" class="form-input" value="å°" onchange="updateDrawRuleData()" />
                    </div>
                </div>
                <div class="form-group">
                    <label>ç›‘æ§å½¢æ€</label>
                    <input type="text" id="bt_monitorPattern" class="form-input" placeholder="0001111" onchange="updateDrawRuleData()" />
                </div>
                <div class="form-group">
                    <label>é¦–æŠ•</label>
                    <select id="bt_initialBet" class="form-input" onchange="updateDrawRuleData()">
                        <option value="0">0 (å¤§)</option>
                        <option value="1">1 (å°)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æŒ‚äº†èµ°ï¼ˆè¾“ååºåˆ—ï¼‰</label>
                    <input type="text" id="bt_lossPattern" class="form-input" placeholder="000001111" onchange="updateDrawRuleData()" />
                </div>
                <div class="form-group">
                    <label>ä¸­äº†èµ°ï¼ˆèµ¢ååºåˆ—ï¼‰</label>
                    <input type="text" id="bt_winPattern" class="form-input" placeholder="1110000" onchange="updateDrawRuleData()" />
                </div>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="bt_stopOnWin" checked onchange="updateDrawRuleData()" />
                    <span>ä¸­å¥–å³åœ</span>
                </label>
            </div>`,
        6: `<!-- ç»“æœè·Ÿéš -->
            <div class="rule-form-section">
                <div style="display: flex; gap: 12px;">
                    <div class="form-group" style="flex: 1;">
                        <label>0 ä»£è¡¨</label>
                        <input type="text" id="rf_codeZero" class="form-input" value="å¤§" onchange="updateDrawRuleData()" />
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>1 ä»£è¡¨</label>
                        <input type="text" id="rf_codeOne" class="form-input" value="å°" onchange="updateDrawRuleData()" />
                    </div>
                </div>
                <div class="form-group">
                    <label>å¼€0ååºåˆ—</label>
                    <input type="text" id="rf_sequenceOnZero" class="form-input" placeholder="000111" onchange="updateDrawRuleData()" />
                </div>
                <div class="form-group">
                    <label>å¼€1ååºåˆ—</label>
                    <input type="text" id="rf_sequenceOnOne" class="form-input" placeholder="111000" onchange="updateDrawRuleData()" />
                </div>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="rf_stopOnWin" checked onchange="updateDrawRuleData()" />
                    <span>ä¸­å¥–å³åœ</span>
                </label>
            </div>`
    };
    
    // ç”¨äºç‰¹æ®Šè§„åˆ™çš„æ•°æ®
    let targetNumbers = [];
    let followLastRules = [];
    let patternStrategies = [];

    document.addEventListener('DOMContentLoaded', async function() {
        try {
            await loadGroups();
            renderSequence();
            updateDrawRuleForm();
            
            if (isEdit) {
                document.getElementById('deleteSection').style.display = 'block';
                await loadScheme();
            }
            
            updatePositionPanel();
            updateOddsPreview();
            updateDrawRulePreview();
        } finally {
            // åŠ è½½å®Œæˆï¼Œéšè—é®ç½©å±‚
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
    });

    function togglePanel(panelId) {
        const panel = document.getElementById(panelId);
        const iconId = panelId.replace('Panel', 'Icon');
        const icon = document.getElementById(iconId);
        
        if (panel.style.display === 'none') {
            panel.style.display = 'block';
            icon.classList.add('expanded');
        } else {
            panel.style.display = 'none';
            icon.classList.remove('expanded');
        }
    }

    async function loadGroups() {
        try {
            const response = await fetch(`${API_BASE_URL}/telegram/chats`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const result = await response.json();
            if (result.success && result.data) {
                groupsList = result.data;
                updateGroupSelect();
            }
        } catch (error) {
            console.error('åŠ è½½ç¾¤ç»„å¤±è´¥:', error);
        }
    }

    function updateGroupSelect() {
        const select = document.getElementById('tgGroupSelect');
        select.innerHTML = '<option value="">è¯·é€‰æ‹©ç¾¤ç»„...</option>';
        groupsList.forEach(g => {
            const option = document.createElement('option');
            option.value = g.id;
            option.textContent = `${g.name} (${g.isChannel ? 'é¢‘é“' : 'ç¾¤ç»„'})`;
            option.dataset.name = g.name;
            select.appendChild(option);
        });
    }

    async function refreshGroups() {
        try {
            // è°ƒç”¨åˆ·æ–° APIï¼ˆä» Telegram è·å–æœ€æ–°å¹¶ä¿å­˜åˆ°æ•°æ®åº“ï¼‰
            const response = await fetch(`${API_BASE_URL}/telegram/refresh-chats`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const result = await response.json();
            if (result.success && result.data) {
                groupsList = result.data;
                updateGroupSelect();
                alert(`âœ… ${result.message || 'åˆ·æ–°æˆåŠŸ'}`);
            } else {
                alert(`âŒ ${result.message || 'åˆ·æ–°å¤±è´¥'}`);
            }
        } catch (error) {
            console.error('åˆ·æ–°ç¾¤ç»„å¤±è´¥:', error);
            alert('åˆ·æ–°ç¾¤ç»„å¤±è´¥ï¼š' + error.message);
        }
    }

    async function loadScheme() {
        try {
            const response = await fetch(`${API_BASE_URL}/scheme/${schemeId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const result = await response.json();
            
            if (result.success && result.data) {
                const s = result.data;
                document.getElementById('schemeName').value = s.name || '';
                document.getElementById('tgGroupSelect').value = s.tgGroupId || '';
                document.getElementById('gameType').value = s.gameType || 0;
                document.getElementById('playMode').value = s.playMode || 0;
                document.getElementById('oddsType').value = s.oddsType || 0;
                document.getElementById('drawRule').value = s.drawRule || 0;
                document.getElementById('isEnabled').checked = s.isEnabled;
                document.getElementById('enableStopProfitLoss').checked = s.enableStopProfitLoss;
                document.getElementById('stopProfitAmount').value = s.stopProfitAmount || '';
                document.getElementById('stopLossAmount').value = s.stopLossAmount || '';
                
                // ä½ç½®
                if (s.positionLst) {
                    const positions = JSON.parse(s.positionLst);
                    document.querySelectorAll('input[name="position"]').forEach(cb => {
                        cb.checked = positions.includes(parseInt(cb.value));
                    });
                }
                
                // å€ç‡é…ç½®
                if (s.oddsConfig) {
                    const config = JSON.parse(s.oddsConfig);
                    // å…¼å®¹å¤§å°å†™ï¼šåç«¯å¯èƒ½è¿”å› Sequence æˆ– sequence
                    const seq = config.Sequence || config.sequence;
                    if (seq) {
                        oddsSequence = seq;
                        renderSequence();
                    }
                    // å…¼å®¹å¤§å°å†™ï¼šProgressMode æˆ– progressMode
                    const progMode = config.ProgressMode ?? config.progressMode;
                    if (progMode !== undefined) {
                        document.getElementById('progressMode').value = progMode;
                    }
                }
                
                // å‡ºå·è§„åˆ™é…ç½®
                if (s.drawRuleConfig) {
                    drawRuleData = JSON.parse(s.drawRuleConfig);
                    updateDrawRuleForm();
                    loadDrawRuleData();
                }
                
                updatePositionPanel();
                toggleStopProfitLoss();
                updateOddsPreview();
                updateDrawRulePreview();
            }
        } catch (error) {
            console.error('åŠ è½½æ–¹æ¡ˆå¤±è´¥:', error);
        }
    }

    // ============ å€ç‡é…ç½® ============
    function renderSequence() {
        const container = document.getElementById('sequenceList');
        container.innerHTML = '';
        
        oddsSequence.forEach((val, idx) => {
            const div = document.createElement('div');
            div.style.cssText = 'display: flex; align-items: center; gap: 8px;';
            div.innerHTML = `
                <span style="color: var(--text-tertiary); min-width: 50px; font-size: 13px;">ç¬¬${idx + 1}å…³</span>
                <input type="number" class="form-input" value="${val}" min="1" 
                       onchange="updateSequenceValue(${idx}, this.value)" style="flex: 1;" />
                <button type="button" class="btn-icon-small" onclick="removeSequenceItem(${idx})">ğŸ—‘ï¸</button>
            `;
            container.appendChild(div);
        });
        
        updateOddsPreview();
    }

    function updateSequenceValue(idx, val) {
        oddsSequence[idx] = parseInt(val) || 1;
        updateOddsPreview();
    }

    function addSequenceItem() {
        const lastVal = oddsSequence.length > 0 ? oddsSequence[oddsSequence.length - 1] : 10;
        oddsSequence.push(lastVal * 2);
        renderSequence();
    }

    function removeSequenceItem(idx) {
        if (oddsSequence.length <= 1) {
            alert('è‡³å°‘ä¿ç•™ä¸€å…³');
            return;
        }
        oddsSequence.splice(idx, 1);
        renderSequence();
    }

    function generateSequence() {
        const start = parseInt(document.getElementById('quickStart').value) || 10;
        const multiplier = parseFloat(document.getElementById('quickMultiplier').value) || 2;
        const count = parseInt(document.getElementById('quickCount').value) || 10;
        
        oddsSequence = [];
        let current = start;
        for (let i = 0; i < count; i++) {
            oddsSequence.push(Math.round(current));
            current *= multiplier;
        }
        
        renderSequence();
    }

    function updateOddsPreview() {
        const preview = document.getElementById('oddsPreview');
        if (oddsSequence.length > 0) {
            const seq = oddsSequence.slice(0, 3).join(', ');
            const suffix = oddsSequence.length > 3 ? '...' : '';
            preview.textContent = `âœ“ ${seq}${suffix} (å…±${oddsSequence.length}å…³)`;
            preview.style.color = 'var(--success-color)';
        } else {
            preview.textContent = 'æœªé…ç½®';
            preview.style.color = 'var(--text-tertiary)';
        }
    }

    // ============ å‡ºå·è§„åˆ™ ============
    function updateDrawRuleForm() {
        const ruleType = parseInt(document.getElementById('drawRule').value);
        const container = document.getElementById('drawRuleFormContainer');
        container.innerHTML = ruleFormTemplates[ruleType] || '';
        
        // åˆå§‹åŒ–ç‰¹æ®Šè§„åˆ™çš„æ•°æ®
        if (ruleType === 0) {
            renderTargetNumbers();
        } else if (ruleType === 1) {
            renderFollowLastRules();
        } else if (ruleType === 4) {
            renderPatternStrategies();
        }
        
        updateDrawRulePreview();
    }

    function loadDrawRuleData() {
        const ruleType = parseInt(document.getElementById('drawRule').value);
        
        switch(ruleType) {
            case 0:
                // å…¼å®¹æ–°æ—§å­—æ®µå
                if (drawRuleData.betNumbers || drawRuleData.targetNumbers) {
                    targetNumbers = drawRuleData.betNumbers || drawRuleData.targetNumbers;
                    renderTargetNumbers();
                }
                break;
            case 1:
                if (drawRuleData.drawRuleDic) {
                    followLastRules = Object.entries(drawRuleData.drawRuleDic).map(([k, v]) => ({
                        trigger: k, targets: v.join(',')
                    }));
                    renderFollowLastRules();
                }
                break;
            case 2:
                if (drawRuleData.monitorRule) {
                    const r = drawRuleData.monitorRule;
                    document.getElementById('sd_monitorTags').value = r.monitorTags || '';
                    document.getElementById('sd_consecutiveCount').value = r.requiredConsecutiveCount || 3;
                    document.getElementById('sd_triggerMode').value = r.triggerMode || 0;
                    document.getElementById('sd_betMode').value = r.betMode || 0;
                }
                break;
            case 3:
                document.getElementById('nt_monitorNumbers').value = drawRuleData.monitorNumbers || '';
                document.getElementById('nt_isOmissionMode').value = String(drawRuleData.isOmissionMode !== false);
                document.getElementById('nt_thresholdCount').value = drawRuleData.thresholdCount || 10;
                document.getElementById('nt_betMode').value = drawRuleData.betMode || 0;
                break;
            case 4:
                document.getElementById('pt_codeZero').value = drawRuleData.codeZeroDefinition || 'å¤§';
                document.getElementById('pt_codeOne').value = drawRuleData.codeOneDefinition || 'å°';
                if (drawRuleData.strategyList) {
                    patternStrategies = drawRuleData.strategyList;
                    renderPatternStrategies();
                }
                break;
            case 5:
                document.getElementById('bt_codeZero').value = drawRuleData.codeZeroDefinition || 'å¤§';
                document.getElementById('bt_codeOne').value = drawRuleData.codeOneDefinition || 'å°';
                document.getElementById('bt_monitorPattern').value = drawRuleData.monitorPattern || '';
                document.getElementById('bt_initialBet').value = drawRuleData.initialBet || '0';
                document.getElementById('bt_lossPattern').value = drawRuleData.lossPattern || '';
                document.getElementById('bt_winPattern').value = drawRuleData.winPattern || '';
                document.getElementById('bt_stopOnWin').checked = drawRuleData.stopOnWin !== false;
                break;
            case 6:
                document.getElementById('rf_codeZero').value = drawRuleData.codeZeroDefinition || 'å¤§';
                document.getElementById('rf_codeOne').value = drawRuleData.codeOneDefinition || 'å°';
                document.getElementById('rf_sequenceOnZero').value = drawRuleData.sequenceOnZero || '';
                document.getElementById('rf_sequenceOnOne').value = drawRuleData.sequenceOnOne || '';
                document.getElementById('rf_stopOnWin').checked = drawRuleData.stopOnWin !== false;
                break;
        }
    }

    function updateDrawRuleData() {
        updateDrawRulePreview();
    }

    function updateDrawRulePreview() {
        const preview = document.getElementById('drawRulePreview');
        const ruleType = parseInt(document.getElementById('drawRule').value);
        const ruleNames = ['å›ºå®šå·ç ', 'å¼€æŸæŠ•æŸ', 'æ–©é¾™è·Ÿé¾™', 'å·ç èµ°åŠ¿', '01å½¢æ€', 'åˆ†æ”¯èµ°åŠ¿', 'ç»“æœè·Ÿéš'];
        preview.textContent = `âœ“ ${ruleNames[ruleType]}`;
        preview.style.color = 'var(--success-color)';
    }

    // å›ºå®šå·ç 
    function renderTargetNumbers() {
        const container = document.getElementById('targetNumbersList');
        if (!container) return;
        container.innerHTML = '';
        targetNumbers.forEach((num, idx) => {
            container.innerHTML += `<span class="tag-item">${num} <span class="remove" onclick="removeTargetNumber(${idx})">Ã—</span></span>`;
        });
    }

    function addTargetNumber() {
        const input = document.getElementById('newTargetNumber');
        const val = input.value.trim();
        if (val && !targetNumbers.includes(val)) {
            targetNumbers.push(val);
            renderTargetNumbers();
            input.value = '';
        }
    }

    function removeTargetNumber(idx) {
        targetNumbers.splice(idx, 1);
        renderTargetNumbers();
    }

    // å¼€æŸæŠ•æŸ
    function renderFollowLastRules() {
        const container = document.getElementById('followLastRules');
        if (!container) return;
        container.innerHTML = '';
        followLastRules.forEach((rule, idx) => {
            container.innerHTML += `
                <div style="display: flex; gap: 8px; align-items: center;">
                    <span style="color: var(--text-tertiary); font-size: 13px;">å¼€</span>
                    <input type="text" class="form-input" value="${rule.trigger}" placeholder="å¤§" 
                           style="width: 60px;" onchange="updateFollowLastRule(${idx}, 'trigger', this.value)" />
                    <span style="color: var(--text-tertiary); font-size: 13px;">æŠ•</span>
                    <input type="text" class="form-input" value="${rule.targets}" placeholder="å°,å•" 
                           style="flex: 1;" onchange="updateFollowLastRule(${idx}, 'targets', this.value)" />
                    <button class="btn-icon-small" onclick="removeFollowLastRule(${idx})">ğŸ—‘ï¸</button>
                </div>
            `;
        });
    }

    function addFollowLastRule() {
        followLastRules.push({ trigger: '', targets: '' });
        renderFollowLastRules();
    }

    function updateFollowLastRule(idx, field, val) {
        followLastRules[idx][field] = val;
    }

    function removeFollowLastRule(idx) {
        followLastRules.splice(idx, 1);
        renderFollowLastRules();
    }

    // 01å½¢æ€ç­–ç•¥
    function renderPatternStrategies() {
        const container = document.getElementById('patternStrategyList');
        if (!container) return;
        container.innerHTML = '';
        patternStrategies.forEach((s, idx) => {
            container.innerHTML += `
                <div style="padding: 8px; background: var(--bg-primary); border-radius: var(--radius-sm); display: flex; gap: 8px; align-items: center;">
                    <input type="text" class="form-input" value="${s.monitorPattern || ''}" placeholder="ç›‘æ§:000" style="flex: 1;"
                           onchange="updatePatternStrategy(${idx}, 'monitorPattern', this.value)" />
                    <span>â†’</span>
                    <input type="text" class="form-input" value="${s.betPattern || ''}" placeholder="æŠ•æ³¨:111" style="flex: 1;"
                           onchange="updatePatternStrategy(${idx}, 'betPattern', this.value)" />
                    <button class="btn-icon-small" onclick="removePatternStrategy(${idx})">ğŸ—‘ï¸</button>
                </div>
            `;
        });
    }

    function addPatternStrategy() {
        patternStrategies.push({ monitorPattern: '', betPattern: '', stopOnWin: true });
        renderPatternStrategies();
    }

    function updatePatternStrategy(idx, field, val) {
        patternStrategies[idx][field] = val;
    }

    function removePatternStrategy(idx) {
        patternStrategies.splice(idx, 1);
        renderPatternStrategies();
    }

    // ============ å…¶ä»– ============
    function updatePositionPanel() {
        const playMode = parseInt(document.getElementById('playMode').value);
        const needPosition = [1100, 1102, 1202, 1203].includes(playMode);
        document.getElementById('positionGroup').style.display = needPosition ? 'block' : 'none';
    }

    function toggleStopProfitLoss() {
        const enabled = document.getElementById('enableStopProfitLoss').checked;
        document.getElementById('stopProfitLossGroup').style.display = enabled ? 'block' : 'none';
    }

    function buildDrawRuleConfig() {
        const ruleType = parseInt(document.getElementById('drawRule').value);
        
        switch(ruleType) {
            case 0:
                return { "$type": "fixed_number", betNumbers: targetNumbers };
            case 1:
                const dic = {};
                followLastRules.forEach(r => {
                    if (r.trigger) {
                        dic[r.trigger] = r.targets.split(',').map(s => s.trim()).filter(s => s);
                    }
                });
                return { "$type": "followlast_number", drawRuleDic: dic };
            case 2:
                return {
                    "$type": "SlayDragon_number",
                    monitorRule: {
                        monitorTags: document.getElementById('sd_monitorTags')?.value || '',
                        requiredConsecutiveCount: parseInt(document.getElementById('sd_consecutiveCount')?.value) || 3,
                        triggerMode: parseInt(document.getElementById('sd_triggerMode')?.value) || 0,
                        betMode: parseInt(document.getElementById('sd_betMode')?.value) || 0,
                        continueBetCount: 3,
                        fixedBetContent: ''
                    }
                };
            case 3:
                return {
                    "$type": "NumberTrend_number",
                    monitorNumbers: document.getElementById('nt_monitorNumbers')?.value || '',
                    isOmissionMode: document.getElementById('nt_isOmissionMode')?.value === 'true',
                    thresholdCount: parseInt(document.getElementById('nt_thresholdCount')?.value) || 10,
                    isFullMatch: false,
                    triggerMode: 0,
                    betMode: parseInt(document.getElementById('nt_betMode')?.value) || 0,
                    continueBetCount: 1,
                    fixedBetContent: ''
                };
            case 4:
                return {
                    "$type": "PatternTrend_number",
                    codeZeroDefinition: document.getElementById('pt_codeZero')?.value || 'å¤§',
                    codeOneDefinition: document.getElementById('pt_codeOne')?.value || 'å°',
                    strategyList: patternStrategies
                };
            case 5:
                return {
                    "$type": "BranchTrend_number",
                    codeZeroDefinition: document.getElementById('bt_codeZero')?.value || 'å¤§',
                    codeOneDefinition: document.getElementById('bt_codeOne')?.value || 'å°',
                    monitorPattern: document.getElementById('bt_monitorPattern')?.value || '',
                    initialBet: document.getElementById('bt_initialBet')?.value || '0',
                    lossPattern: document.getElementById('bt_lossPattern')?.value || '',
                    winPattern: document.getElementById('bt_winPattern')?.value || '',
                    stopOnWin: document.getElementById('bt_stopOnWin')?.checked !== false
                };
            case 6:
                return {
                    "$type": "ResultFollow_number",
                    codeZeroDefinition: document.getElementById('rf_codeZero')?.value || 'å¤§',
                    codeOneDefinition: document.getElementById('rf_codeOne')?.value || 'å°',
                    sequenceOnZero: document.getElementById('rf_sequenceOnZero')?.value || '',
                    sequenceOnOne: document.getElementById('rf_sequenceOnOne')?.value || '',
                    stopOnWin: document.getElementById('rf_stopOnWin')?.checked !== false
                };
            default:
                return null;
        }
    }

    async function saveScheme() {
        const name = document.getElementById('schemeName').value.trim();
        if (!name) {
            alert('è¯·è¾“å…¥æ–¹æ¡ˆåç§°');
            return;
        }
        
        const tgGroupSelect = document.getElementById('tgGroupSelect');
        const tgGroupId = tgGroupSelect.value;
        if (!tgGroupId) {
            alert('è¯·é€‰æ‹© Telegram ç¾¤ç»„');
            return;
        }
        
        const selectedOption = tgGroupSelect.options[tgGroupSelect.selectedIndex];
        const tgGroupName = selectedOption.dataset.name || selectedOption.text;
        
        const positions = [];
        document.querySelectorAll('input[name="position"]:checked').forEach(cb => {
            positions.push(parseInt(cb.value));
        });
        
        const oddsConfig = {
            "$type": "linear",
            sequence: oddsSequence,
            progressMode: parseInt(document.getElementById('progressMode').value)
        };
        
        const drawRuleConfig = buildDrawRuleConfig();
        
        const data = {
            name: name,
            tgGroupName: tgGroupName,
            tgGroupId: parseInt(tgGroupId),
            gameType: parseInt(document.getElementById('gameType').value),
            playMode: parseInt(document.getElementById('playMode').value),
            oddsType: parseInt(document.getElementById('oddsType').value),
            positionLst: positions,
            oddsConfig: oddsConfig,
            drawRule: parseInt(document.getElementById('drawRule').value),
            drawRuleConfig: drawRuleConfig,
            enableStopProfitLoss: document.getElementById('enableStopProfitLoss').checked,
            stopProfitAmount: parseFloat(document.getElementById('stopProfitAmount').value) || 0,
            stopLossAmount: parseFloat(document.getElementById('stopLossAmount').value) || 0,
            isEnabled: document.getElementById('isEnabled').checked
        };
        
        const saveBtn = document.getElementById('saveBtn');
        saveBtn.disabled = true;
        saveBtn.textContent = 'ä¿å­˜ä¸­...';
        
        try {
            const url = isEdit ? `${API_BASE_URL}/scheme/${schemeId}` : `${API_BASE_URL}/scheme`;
            const method = isEdit ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.success) {
                window.location.href = '/Home/Schemes';
            } else {
                alert(result.message || 'ä¿å­˜å¤±è´¥');
            }
        } catch (error) {
            alert('ç½‘ç»œé”™è¯¯');
            console.error(error);
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = 'ä¿å­˜';
        }
    }

    async function deleteScheme() {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–¹æ¡ˆå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;
        
        try {
            const response = await fetch(`${API_BASE_URL}/scheme/${schemeId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            const result = await response.json();
            if (result.success) {
                window.location.href = '/Home/Schemes';
            } else {
                alert(result.message || 'åˆ é™¤å¤±è´¥');
            }
        } catch (error) {
            alert('ç½‘ç»œé”™è¯¯');
        }
    }

    function goBack() {
        window.location.href = '/Home/Schemes';
    }
</script>
}
