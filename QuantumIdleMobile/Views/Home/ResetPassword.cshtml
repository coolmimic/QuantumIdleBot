@{
    ViewData["Title"] = "é‡ç½®å¯†ç ";
    Layout = "_Layout";
}

<div class="auth-container">
    <div class="auth-card">
        <div class="auth-logo">
            <h1>ğŸ”„ é‡ç½®å¯†ç </h1>
            <p>ä½¿ç”¨æ—§å¯†ç éªŒè¯èº«ä»½</p>
        </div>
        
        <form id="resetForm">
            <div class="form-group">
                <label for="username">ç”¨æˆ·å</label>
                <input type="text" id="username" name="username" class="form-input" 
                       placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required />
            </div>
            
            <div class="form-group">
                <label for="oldPassword">æ—§å¯†ç </label>
                <input type="password" id="oldPassword" name="oldPassword" class="form-input" 
                       placeholder="è¯·è¾“å…¥æ—§å¯†ç " required />
            </div>
            
            <div class="form-group">
                <label for="newPassword">æ–°å¯†ç </label>
                <input type="password" id="newPassword" name="newPassword" class="form-input" 
                       placeholder="è¯·è¾“å…¥æ–°å¯†ç " required minlength="6" />
            </div>
            
            <div class="form-group">
                <label for="confirmPassword">ç¡®è®¤å¯†ç </label>
                <input type="password" id="confirmPassword" name="confirmPassword" class="form-input" 
                       placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç " required />
            </div>

            <div class="form-group">
                <label for="captcha">éªŒè¯ç </label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="captcha" name="captcha" class="form-input" 
                           placeholder="è¯·è¾“å…¥éªŒè¯ç " required style="flex: 1;" maxlength="4" />
                    <img id="captchaImage" src="" alt="éªŒè¯ç " 
                         style="height: 40px; cursor: pointer; border-radius: 4px; background: #f0f0f0;" 
                         title="ç‚¹å‡»åˆ·æ–°éªŒè¯ç " onclick="refreshCaptcha()" />
                </div>
            </div>
            
            <div class="form-group">
                <button type="submit" class="btn btn-primary btn-block" id="resetBtn">
                    é‡ç½®å¯†ç 
                </button>
            </div>
            
            <div id="resultMessage" style="display: none; margin-top: 12px;"></div>
        </form>
        
        <div class="auth-footer">
            <a href="/Home/Login">â† è¿”å›ç™»å½•</a>
        </div>
    </div>
</div>

@section Scripts {
<script>
    const API_BASE_URL = API_CONFIG.baseUrl;
    let currentCaptchaId = '';

    document.addEventListener('DOMContentLoaded', refreshCaptcha);

    async function refreshCaptcha() {
        try {
            const response = await fetch(`${API_BASE_URL}/user/captcha`);
            const result = await response.json();
            if (result.success) {
                currentCaptchaId = result.data.captchaId;
                document.getElementById('captchaImage').src = result.data.image;
            }
        } catch (error) {
            console.error('è·å–éªŒè¯ç å¤±è´¥:', error);
        }
    }

    document.getElementById('resetForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const username = document.getElementById('username').value.trim();
        const oldPassword = document.getElementById('oldPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const captchaCode = document.getElementById('captcha').value.trim();
        const resultDiv = document.getElementById('resultMessage');
        const btn = document.getElementById('resetBtn');
        
        if (newPassword !== confirmPassword) {
            resultDiv.innerHTML = `<div style="color: var(--error-color); padding: 12px; background: rgba(255, 77, 79, 0.1); border-radius: var(--radius-sm);">âŒ ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´</div>`;
            resultDiv.style.display = 'block';
            return;
        }

        if (!captchaCode || captchaCode.length !== 4) {
            resultDiv.innerHTML = `<div style="color: var(--error-color); padding: 12px; background: rgba(255, 77, 79, 0.1); border-radius: var(--radius-sm);">âŒ è¯·è¾“å…¥4ä½éªŒè¯ç </div>`;
            resultDiv.style.display = 'block';
            return;
        }
        
        btn.disabled = true;
        btn.textContent = 'é‡ç½®ä¸­...';
        resultDiv.style.display = 'none';
        
        try {
            const response = await fetch(`${API_BASE_URL}/user/reset-password`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    userName: username, 
                    oldPassword: oldPassword,
                    newPassword: newPassword,
                    captchaId: currentCaptchaId,
                    captchaCode: captchaCode
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                resultDiv.innerHTML = `<div style="color: var(--success-color); padding: 12px; background: rgba(82, 196, 26, 0.1); border-radius: var(--radius-sm);">âœ… ${result.message}</div>`;
            } else {
                resultDiv.innerHTML = `<div style="color: var(--error-color); padding: 12px; background: rgba(255, 77, 79, 0.1); border-radius: var(--radius-sm);">âŒ ${result.message}</div>`;
                refreshCaptcha();
                document.getElementById('captcha').value = '';
            }
            resultDiv.style.display = 'block';
        } catch (error) {
            resultDiv.innerHTML = `<div style="color: var(--error-color); padding: 12px; background: rgba(255, 77, 79, 0.1); border-radius: var(--radius-sm);">âŒ ç½‘ç»œé”™è¯¯</div>`;
            resultDiv.style.display = 'block';
            refreshCaptcha();
        } finally {
            btn.disabled = false;
            btn.textContent = 'é‡ç½®å¯†ç ';
        }
    });
</script>
}
