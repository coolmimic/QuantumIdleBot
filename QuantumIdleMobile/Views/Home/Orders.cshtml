@{
    ViewData["Title"] = "æ³¨å•åˆ—è¡¨";
}

<div class="page-container">
    <div class="header">
        <h1>ğŸ“ æ³¨å•åˆ—è¡¨</h1>
        <button class="btn-icon" onclick="refreshOrders()">åˆ·æ–°</button>
    </div>
    
    <div class="content">
        <!-- ç­›é€‰å·¥å…·æ  -->
        <div class="filter-bar">
            <select id="pageSize" class="form-input filter-select">
                <option value="20">20 æ¡</option>
                <option value="50">50 æ¡</option>
                <option value="100">100 æ¡</option>
            </select>
            <div class="stats-summary" id="statsSummary">
                <span class="stat-item">æ€»è®¡: <strong id="totalOrders">0</strong></span>
                <span class="stat-item profit-positive" id="totalProfit">+0.00</span>
            </div>
        </div>
        
        <!-- æ³¨å•åˆ—è¡¨ -->
        <div id="ordersList" class="orders-container">
            <div class="loading-state">
                <div class="spinner"></div>
                <p>åŠ è½½ä¸­...</p>
            </div>
        </div>
        
        <!-- åˆ†é¡µ -->
        <div class="pagination">
            <button id="prevPage" class="btn btn-secondary" onclick="changePage(-1)">
                â† ä¸Šä¸€é¡µ
            </button>
            <span id="pageInfo">ç¬¬ 1 é¡µ</span>
            <button id="nextPage" class="btn btn-secondary" onclick="changePage(1)">
                ä¸‹ä¸€é¡µ â†’
            </button>
        </div>
    </div>
    
    <div class="bottom-nav">
        <a href="/Home/Dashboard" class="nav-item">
            <span class="nav-icon">ğŸ </span>
            <span class="nav-text">é¦–é¡µ</span>
        </a>
        <a href="/Home/Telegram" class="nav-item">
            <span class="nav-icon">ğŸ“±</span>
            <span class="nav-text">TGè¿æ¥</span>
        </a>
        <a href="/Home/Schemes" class="nav-item">
            <span class="nav-icon">ğŸ“‹</span>
            <span class="nav-text">æ–¹æ¡ˆ</span>
        </a>
        <a href="/Home/Orders" class="nav-item active">
            <span class="nav-icon">ğŸ“</span>
            <span class="nav-text">æ³¨å•</span>
        </a>
        <a href="/Home/Settings" class="nav-item">
            <span class="nav-icon">âš™ï¸</span>
            <span class="nav-text">è®¾ç½®</span>
        </a>
    </div>
</div>

<style>
    .filter-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
        margin-bottom: 12px;
    }
    .filter-select {
        width: auto;
        min-width: 100px;
    }
    .stats-summary {
        display: flex;
        gap: 16px;
        font-size: 13px;
    }
    .stats-summary .stat-item {
        color: var(--text-secondary);
    }
    
    .orders-container {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .loading-state, .empty-state, .error-state {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-secondary);
    }
    .loading-state .spinner {
        width: 32px;
        height: 32px;
        border: 3px solid rgba(255, 255, 255, 0.2);
        border-top-color: var(--accent-color);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin: 0 auto 12px;
    }
    @@keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* æ³¨å•å¡ç‰‡ - ç´§å‡‘å‹è®¾è®¡ */
    .order-item {
        background: var(--bg-secondary);
        border-radius: var(--radius-md);
        padding: 12px;
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 8px;
        border-left: 3px solid var(--text-tertiary);
        transition: all 0.2s;
    }
    .order-item:hover {
        background: var(--bg-tertiary);
    }
    .order-item.win {
        border-left-color: #ff6b6b;      /* çº¢è‰² - èµ¢ï¼ˆä¸­ï¼‰ */
    }
    .order-item.lose {
        border-left-color: #51cf66;      /* ç»¿è‰² - è¾“ï¼ˆæŒ‚ï¼‰ */
    }
    .order-item.pending {
        border-left-color: var(--warning-color);
    }
    
    .order-main {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }
    .order-row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        font-size: 13px;
    }
    .order-row .field {
        display: flex;
        gap: 4px;
    }
    .order-row .label {
        color: var(--text-tertiary);
    }
    .order-row .value {
        color: var(--text-primary);
        font-weight: 500;
    }
    
    .order-right {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        justify-content: center;
        gap: 4px;
    }
    .order-profit {
        font-size: 16px;
        font-weight: 600;
    }
    .order-status {
        font-size: 11px;
        padding: 2px 8px;
        border-radius: 10px;
        background: var(--bg-tertiary);
        color: var(--text-secondary);
    }
    .order-status.settled {
        background: rgba(82, 196, 26, 0.15);
        color: var(--success-color);
    }
    .order-status.pending {
        background: rgba(250, 173, 20, 0.15);
        color: var(--warning-color);
    }
    
    .profit-positive { color: #ff6b6b; }  /* çº¢è‰² - ç›ˆåˆ©ï¼ˆä¸­ï¼‰ */
    .profit-negative { color: #51cf66; }  /* ç»¿è‰² - äºæŸï¼ˆæŒ‚ï¼‰ */
    
    .pagination {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 16px;
        padding: 12px 0;
    }
    .pagination span {
        color: var(--text-secondary);
        font-size: 14px;
    }
</style>

@section Scripts {
<script>
    const API_BASE_URL = API_CONFIG.baseUrl;
    
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = '/Home/Login';
    }
    
    let currentPage = 1;
    let pageSize = 20;
    let schemeMap = {}; // ç¼“å­˜æ–¹æ¡ˆåæ˜ å°„
    
    // åŠ è½½æ–¹æ¡ˆåˆ—è¡¨è·å–åç§°æ˜ å°„
    async function loadSchemes() {
        try {
            const response = await fetch(`${API_BASE_URL}/scheme/list`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const result = await response.json();
            if (result.success && result.data) {
                result.data.forEach(s => {
                    schemeMap[s.id] = s.name;
                });
            }
        } catch (error) {
            console.error('åŠ è½½æ–¹æ¡ˆå¤±è´¥:', error);
        }
    }
    
    // æ ¼å¼åŒ–æœŸå·ï¼šå¦‚æœ>=4ä½æ˜¾ç¤ºå4ä½
    function formatIssueNumber(issue) {
        if (!issue) return '-';
        return issue.length >= 4 ? '...' + issue.slice(-4) : issue;
    }
    
    // æ ¼å¼åŒ–æ—¶é—´ï¼šåªæ˜¾ç¤ºæ—¶åˆ†ç§’
    function formatTime(dateStr) {
        if (!dateStr) return '-';
        const date = new Date(dateStr);
        return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }
    
    // æ ¼å¼åŒ–æ—¥æœŸ+æ—¶é—´
    function formatDateTime(dateStr) {
        if (!dateStr) return '-';
        const date = new Date(dateStr);
        return date.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' }) + ' ' +
               date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
    }
    
    async function loadOrders() {
        const ordersList = document.getElementById('ordersList');
        ordersList.innerHTML = `
            <div class="loading-state">
                <div class="spinner"></div>
                <p>åŠ è½½ä¸­...</p>
            </div>
        `;
        
        try {
            const response = await fetch(`${API_BASE_URL}/betorder/list?page=${currentPage}&size=${pageSize}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            const result = await response.json();
            
            if (result.success && result.data && result.data.length > 0) {
                let html = '';
                let totalProfit = 0;
                
                result.data.forEach(order => {
                    const schemeName = schemeMap[order.schemeId] || `æ–¹æ¡ˆ#${order.schemeId}`;
                    const issueDisplay = formatIssueNumber(order.issueNumber);
                    const timeDisplay = formatDateTime(order.betTime);
                    const profit = order.profit || 0;
                    totalProfit += profit;
                    
                    // çŠ¶æ€åˆ¤æ–­
                    const isSettled = order.status === 1;
                    const isWin = isSettled && profit > 0;
                    const isLose = isSettled && profit < 0;
                    const itemClass = isWin ? 'win' : (isLose ? 'lose' : 'pending');
                    const statusText = isSettled ? 'å·²ç»“ç®—' : 'å¾…ç»“ç®—';
                    const statusClass = isSettled ? 'settled' : 'pending';
                    
                    const profitClass = profit >= 0 ? 'profit-positive' : 'profit-negative';
                    const profitDisplay = profit >= 0 ? `+${profit.toFixed(2)}` : profit.toFixed(2);
                    
                    html += `
                        <div class="order-item ${itemClass}">
                            <div class="order-main">
                                <div class="order-row">
                                    <div class="field">
                                        <span class="label">æ—¶é—´</span>
                                        <span class="value">${timeDisplay}</span>
                                    </div>
                                    <div class="field">
                                        <span class="label">æ–¹æ¡ˆ</span>
                                        <span class="value">${schemeName}</span>
                                    </div>
                                </div>
                                <div class="order-row">
                                    <div class="field">
                                        <span class="label">æœŸå·</span>
                                        <span class="value">${issueDisplay}</span>
                                    </div>
                                    <div class="field">
                                        <span class="label">ä¸‹æ³¨</span>
                                        <span class="value">${order.betContent || '-'}</span>
                                    </div>
                                    <div class="field">
                                        <span class="label">é‡‘é¢</span>
                                        <span class="value">${order.amount || 0}</span>
                                    </div>
                                    <div class="field">
                                        <span class="label">å¼€å¥–</span>
                                        <span class="value">${order.openResult || '-'}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="order-right">
                                <span class="order-profit ${profitClass}">${profitDisplay}</span>
                                <span class="order-status ${statusClass}">${statusText}</span>
                            </div>
                        </div>
                    `;
                });
                
                ordersList.innerHTML = html;
                
                // æ›´æ–°ç»Ÿè®¡
                document.getElementById('totalOrders').textContent = result.data.length;
                const totalProfitEl = document.getElementById('totalProfit');
                totalProfitEl.textContent = (totalProfit >= 0 ? '+' : '') + totalProfit.toFixed(2);
                totalProfitEl.className = 'stat-item ' + (totalProfit >= 0 ? 'profit-positive' : 'profit-negative');
            } else {
                ordersList.innerHTML = '<div class="empty-state">ğŸ“­ æš‚æ— æ³¨å•è®°å½•</div>';
                document.getElementById('totalOrders').textContent = '0';
                document.getElementById('totalProfit').textContent = '+0.00';
            }
            
            updatePageInfo();
        } catch (error) {
            ordersList.innerHTML = '<div class="error-state">âŒ åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
            console.error('åŠ è½½æ³¨å•å¤±è´¥:', error);
        }
    }
    
    function changePage(delta) {
        currentPage += delta;
        if (currentPage < 1) currentPage = 1;
        loadOrders();
    }
    
    function refreshOrders() {
        currentPage = 1;
        loadOrders();
    }
    
    function updatePageInfo() {
        document.getElementById('pageInfo').textContent = `ç¬¬ ${currentPage} é¡µ`;
        document.getElementById('prevPage').disabled = currentPage <= 1;
    }
    
    document.getElementById('pageSize').addEventListener('change', function(e) {
        pageSize = parseInt(e.target.value);
        currentPage = 1;
        loadOrders();
    });
    
    // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
    (async function() {
        await loadSchemes();
        loadOrders();
    })();
</script>
}
