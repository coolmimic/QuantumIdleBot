@{
    ViewData["Title"] = "è¿è¡Œæ—¥å¿—";
}

<div class="page-container">
    <div class="header">
        <div style="display: flex; align-items: center; gap: 12px;">
            <button class="btn-icon" onclick="goBack()">â†</button>
            <h1>ğŸ“œ è¿è¡Œæ—¥å¿—</h1>
        </div>
        <button class="btn btn-secondary" onclick="clearLogs()">æ¸…é™¤</button>
    </div>
    
    <div class="content log-content">
        <div id="logContainer" class="log-container">
            <div class="log-loading">åŠ è½½ä¸­...</div>
        </div>
    </div>
    
    <div class="bottom-nav">
        <a href="/Home/Dashboard" class="nav-item">
            <span class="nav-icon">ğŸ </span>
            <span class="nav-text">é¦–é¡µ</span>
        </a>
        <a href="/Home/Telegram" class="nav-item">
            <span class="nav-icon">ğŸ“±</span>
            <span class="nav-text">TGè¿æ¥</span>
        </a>
        <a href="/Home/Schemes" class="nav-item">
            <span class="nav-icon">ğŸ“‹</span>
            <span class="nav-text">æ–¹æ¡ˆ</span>
        </a>
        <a href="/Home/History" class="nav-item">
            <span class="nav-icon">ğŸ“Š</span>
            <span class="nav-text">å†å²</span>
        </a>
        <a href="/Home/Settings" class="nav-item">
            <span class="nav-icon">âš™ï¸</span>
            <span class="nav-text">è®¾ç½®</span>
        </a>
    </div>
</div>

<style>
    .log-content {
        padding: 0 !important;
    }
    .log-container {
        background: #0d1117;
        padding: 12px;
        border-radius: var(--radius-md);
        margin: 12px;
        height: calc(100vh - 180px);
        overflow-y: auto;
        font-family: 'Cascadia Mono', 'Consolas', monospace;
        font-size: 13px;
        line-height: 1.6;
    }
    .log-entry {
        color: #58a6ff;
        margin-bottom: 4px;
        padding: 4px 8px;
        border-radius: 4px;
        word-break: break-all;
    }
    .log-entry:hover {
        background: rgba(255,255,255,0.05);
    }
    .log-entry.info {
        color: #8b949e;
    }
    .log-entry.success {
        color: #3fb950;
    }
    .log-entry.warning {
        color: #d29922;
    }
    .log-entry.error {
        color: #f85149;
    }
    .log-entry.highlight {
        color: #a5d6ff;
        font-weight: 600;
    }
    .log-loading, .log-empty {
        color: #8b949e;
        text-align: center;
        padding: 40px;
    }
    .auto-refresh {
        position: fixed;
        bottom: 80px;
        right: 16px;
        z-index: 100;
    }
    .auto-refresh label {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: var(--bg-secondary);
        border-radius: var(--radius-md);
        cursor: pointer;
        font-size: 13px;
    }
</style>

@section Scripts {
<script>
    const port = 5000;
    const protocol = window.location.protocol;
    const hostname = window.location.hostname;
    const API_BASE_URL = `${protocol}//${hostname}:${port}/api`;
    const token = localStorage.getItem('token');
    
    if (!token) {
        window.location.href = '/Home/Login';
    }
    
    let autoRefresh = true;
    let refreshInterval = null;
    
    document.addEventListener('DOMContentLoaded', function() {
        loadLogs();
        startAutoRefresh();
    });

    async function loadLogs() {
        try {
            const response = await fetch(`${API_BASE_URL}/bot/logs?count=200`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                const result = await response.json();
                if (result.success && result.data) {
                    displayLogs(result.data);
                }
            }
        } catch (error) {
            console.error('åŠ è½½æ—¥å¿—å¤±è´¥:', error);
        }
    }

    function displayLogs(logs) {
        const container = document.getElementById('logContainer');
        
        if (logs.length === 0) {
            container.innerHTML = '<div class="log-empty">æš‚æ— æ—¥å¿—</div>';
            return;
        }
        
        let html = '';
        logs.forEach(log => {
            let className = 'log-entry';
            
            // æ ¹æ®å†…å®¹è®¾ç½®ä¸åŒé¢œè‰²
            if (log.includes('>>>') || log.includes('å¼€å§‹') || log.includes('åœæ­¢')) {
                className += ' highlight';
            } else if (log.includes('æˆåŠŸ')) {
                className += ' success';
            } else if (log.includes('å¤±è´¥') || log.includes('é”™è¯¯') || log.includes('Error')) {
                className += ' error';
            } else if (log.includes('è­¦å‘Š') || log.includes('Warning')) {
                className += ' warning';
            } else {
                className += ' info';
            }
            
            html += `<div class="${className}">${escapeHtml(log)}</div>`;
        });
        
        container.innerHTML = html;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function startAutoRefresh() {
        if (refreshInterval) clearInterval(refreshInterval);
        refreshInterval = setInterval(loadLogs, 3000);
    }

    async function clearLogs() {
        if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ—¥å¿—å—ï¼Ÿ')) return;
        
        try {
            const response = await fetch(`${API_BASE_URL}/bot/logs/clear`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                loadLogs();
            }
        } catch (error) {
            console.error('æ¸…é™¤æ—¥å¿—å¤±è´¥:', error);
        }
    }

    function goBack() {
        if (refreshInterval) clearInterval(refreshInterval);
        window.location.href = '/Home/Dashboard';
    }
</script>
}
