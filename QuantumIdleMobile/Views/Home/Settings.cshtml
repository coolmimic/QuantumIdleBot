@{
    ViewData["Title"] = "è®¾ç½®";
}

<div class="page-container">
    <div class="header">
        <h1>âš™ï¸ è®¾ç½®</h1>
    </div>
    
    <div class="content">
        <div class="card">
            <h3>è´¦æˆ·ä¿¡æ¯</h3>
            <div id="userInfoSettings">
                <div class="info-item">
                    <span class="label">ç”¨æˆ·å</span>
                    <span class="value" id="settingsUserName">-</span>
                </div>
                <div class="info-item">
                    <span class="label">åˆ°æœŸæ—¶é—´</span>
                    <span class="value" id="settingsExpireTime">-</span>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h3>API é…ç½®</h3>
            <div class="form-group">
                <label for="apiBaseUrl">æœåŠ¡å™¨åœ°å€</label>
                <input type="text" id="apiBaseUrl" class="form-input" placeholder="http://localhost:5000/api" />
            </div>
            <button class="btn btn-primary" onclick="saveApiUrl()">ä¿å­˜é…ç½®</button>
        </div>
        
        <div class="card">
            <h3>å…³äº</h3>
            <div class="info-item">
                <span class="label">ç‰ˆæœ¬</span>
                <span class="value">v1.0.0</span>
            </div>
            <div class="info-item">
                <span class="label">æ¡†æ¶</span>
                <span class="value">ASP.NET Core 10.0</span>
            </div>
            <div class="info-item">
                <span class="label">UI</span>
                <span class="value">Microsoft Fluent Design</span>
            </div>
        </div>
        
        <div class="card">
            <h3>ğŸ”‘ å¡å¯†æ¿€æ´»</h3>
            <div class="form-group">
                <label for="cardCode">å¡å¯†ç </label>
                <input type="text" id="cardCode" class="form-input" placeholder="è¯·è¾“å…¥å¡å¯†" />
            </div>
            <button class="btn btn-primary btn-block" onclick="activateCard()" id="activateBtn">
                æ¿€æ´»å¡å¯†
            </button>
            <div id="activateResult" style="margin-top: 12px; display: none;"></div>
        </div>
        
        <div class="card" style="margin-top: 24px;">
            <button class="btn btn-danger btn-block" onclick="logout()">
                é€€å‡ºç™»å½•
            </button>
        </div>
    </div>
    
    <div class="bottom-nav">
        <a href="/Home/Dashboard" class="nav-item">
            <span class="nav-icon">ğŸ </span>
            <span class="nav-text">é¦–é¡µ</span>
        </a>
        <a href="/Home/Telegram" class="nav-item">
            <span class="nav-icon">ğŸ“±</span>
            <span class="nav-text">TGè¿æ¥</span>
        </a>
        <a href="/Home/Schemes" class="nav-item">
            <span class="nav-icon">ğŸ“‹</span>
            <span class="nav-text">æ–¹æ¡ˆ</span>
        </a>
        <a href="/Home/History" class="nav-item">
            <span class="nav-icon">ğŸ“Š</span>
            <span class="nav-text">å†å²</span>
        </a>
        <a href="/Home/Settings" class="nav-item active">
            <span class="nav-icon">âš™ï¸</span>
            <span class="nav-text">è®¾ç½®</span>
        </a>
    </div>
</div>

@section Scripts {
<script>
    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = '/Home/Login';
    }
    
    // åŠ è½½ç”¨æˆ·ä¿¡æ¯
    function loadUserSettings() {
        const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
        document.getElementById('settingsUserName').textContent = userInfo.userName || '-';
        
        if (userInfo.expireTime) {
            const expireDate = new Date(userInfo.expireTime);
            document.getElementById('settingsExpireTime').textContent = expireDate.toLocaleString('zh-CN');
        }
    }
    
    const defaultApiUrl = '/api';

    // åŠ è½½ä¿å­˜çš„ API åœ°å€
    const savedApiUrl = localStorage.getItem('apiBaseUrl');
    if (savedApiUrl) {
        document.getElementById('apiBaseUrl').value = savedApiUrl;
    } else {
        document.getElementById('apiBaseUrl').value = defaultApiUrl;
    }
    
    function saveApiUrl() {
        const apiUrl = document.getElementById('apiBaseUrl').value.trim();
        if (!apiUrl) {
            alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ API åœ°å€');
            return;
        }
        localStorage.setItem('apiBaseUrl', apiUrl);
        alert('âœ… é…ç½®å·²ä¿å­˜');
    }
    
    function logout() {
        if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
            localStorage.removeItem('token');
            localStorage.removeItem('userName');
            localStorage.removeItem('userInfo');
            window.location.href = '/Home/Login';
        }
    }
    
    async function activateCard() {
        const cardCode = document.getElementById('cardCode').value.trim();
        if (!cardCode) {
            alert('è¯·è¾“å…¥å¡å¯†');
            return;
        }
        
        const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
        if (!userInfo.userName) {
            alert('ç”¨æˆ·ä¿¡æ¯ä¸¢å¤±ï¼Œè¯·é‡æ–°ç™»å½•');
            return;
        }
        
        const btn = document.getElementById('activateBtn');
        btn.disabled = true;
        btn.textContent = 'æ¿€æ´»ä¸­...';
        
        const resultDiv = document.getElementById('activateResult');
        
        try {
            const response = await fetch(`${defaultApiUrl}/cardkey/activate`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    cardCode: cardCode,
                    userName: userInfo.userName
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                // æ›´æ–°æœ¬åœ°ç”¨æˆ·ä¿¡æ¯
                userInfo.expireTime = result.expireTime;
                localStorage.setItem('userInfo', JSON.stringify(userInfo));
                
                resultDiv.innerHTML = `<div style="color: var(--success-color); padding: 12px; background: rgba(82, 196, 26, 0.1); border-radius: var(--radius-sm);">âœ… ${result.message}</div>`;
                resultDiv.style.display = 'block';
                
                // åˆ·æ–°æ˜¾ç¤º
                loadUserSettings();
                document.getElementById('cardCode').value = '';
            } else {
                resultDiv.innerHTML = `<div style="color: var(--error-color); padding: 12px; background: rgba(255, 77, 79, 0.1); border-radius: var(--radius-sm);">âŒ ${result.message}</div>`;
                resultDiv.style.display = 'block';
            }
        } catch (error) {
            resultDiv.innerHTML = `<div style="color: var(--error-color); padding: 12px; background: rgba(255, 77, 79, 0.1); border-radius: var(--radius-sm);">âŒ ç½‘ç»œé”™è¯¯: ${error.message}</div>`;
            resultDiv.style.display = 'block';
        } finally {
            btn.disabled = false;
            btn.textContent = 'æ¿€æ´»å¡å¯†';
        }
    }
    
    loadUserSettings();
</script>
}
